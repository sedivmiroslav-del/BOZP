<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BOZP Hodnotenie pracovísk</title>
  <meta name="description" content="Aplikácia na hodnotenie BOZP na pracoviskách s importom Excelu, úlohami, prehľadmi a podporou cloudu (Gist) + fotky v GitHub repozitári." />
  <link rel="icon" href="./assets/img/favicon.ico" type="image/x-icon">
  <!-- Knižnice -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --green: rgb(0,137,6);
      --gray: rgb(135,135,135);
      --light-gray: rgb(206,213,218);
      --blue: rgb(29,155,178);
      --lime: rgb(161,200,97);
      --white: rgb(255,255,255);
      --black: rgb(0,0,0);
      --yellow: rgb(255,255,96);

      --radius: 10px;
      --shadow: 0 8px 24px rgba(0,0,0,0.12);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--black);
      background: var(--white);
      line-height: 1.5;
    }

    .app-header {
      background: linear-gradient(90deg, var(--blue), var(--green));
      color: #fff;
      padding: 14px clamp(16px, 4vw, 32px);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }
    .brand { display: flex; align-items: center; gap: 12px; }
    .brand h1 { margin: 0; font-size: clamp(18px, 2.2vw, 26px); }

    .app-nav { display:flex; align-items:center; gap:16px; flex-wrap:wrap; }
    .app-nav ul { list-style: none; display: flex; gap: 8px; margin: 0; padding: 0; flex-wrap: wrap; }
    .app-nav a { color: #fff; text-decoration: none; padding: 8px 12px; border-radius: 8px; }
    .app-nav a:hover, .app-nav a[aria-current="page"] { background: rgba(255,255,255,0.2); }

    /* Cloud akcie v hornej lište – už iba Obnoviť */
    .header-actions { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .header-actions .btn { background:#fff; color:#000; border:1px solid var(--light-gray); }
    .header-actions .btn:hover { background: rgb(246,251,253); }

    .app-main { padding: 16px clamp(16px,4vw,32px); }

    .btn { appearance: none; border: 1px solid transparent; border-radius: 10px; padding: 8px 12px; font-weight: 600; cursor: pointer; transition: transform .04s, background-color .2s, border-color .2s, color .2s, box-shadow .2s; }
    .btn:active { transform: translateY(1px); }
    .btn.primary { background: var(--yellow); color: #000; border-color: rgba(0,0,0,.12); }
    .btn.primary:hover { background: rgb(245,245,120); }
    .btn.secondary { background: #fff; color: #000; border-color: var(--light-gray); }
    .btn.secondary:hover { background: rgb(246,251,253); }
    .btn.danger { background: #fff; color: #8b0000; border-color: #caa; }
    .btn.danger:hover { background: #ffecec; }
    .btn.icon-btn { background: transparent; color: var(--black); font-size: 1.2rem; border: none; }

    .cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 12px; }
    .card { background: var(--light-gray); border-radius: var(--radius); padding: 12px; box-shadow: var(--shadow); }
    .stat-number { font-size: 1.8rem; font-weight: 700; }

    .filters, .selector-bar { display: flex; flex-wrap: wrap; gap: 12px; align-items: flex-end; margin-bottom: 12px; }
    .filter-group { display: flex; flex-direction: column; min-width: 180px; }

    .form { background: var(--white); border: 1px solid var(--light-gray); border-radius: var(--radius); padding: 12px; box-shadow: var(--shadow); }
    fieldset { border: none; padding: 0; }
    legend { font-weight: 700; margin-bottom: 8px; }

    .form-row { display: grid; grid-template-columns: 200px 1fr; gap: 8px; align-items: center; margin-bottom: 8px; }
    .form-actions { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }

    input[type="text"], input[type="password"], input[type="date"], input[type="search"], input[type="number"], select {
      width: 100%; padding: 8px; border-radius: 8px; border: 1px solid var(--light-gray);
    }
    input[type="file"] { padding: 6px; border: 1px dashed var(--light-gray); border-radius: 8px; }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .panel { background: var(--white); border: 1px solid var(--light-gray); border-radius: var(--radius); padding: 12px; box-shadow: var(--shadow); }

    .table-wrap { margin-top: 16px; background: var(--white); border: 1px solid var(--light-gray); border-radius: var(--radius); overflow-x: auto; }
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { border-bottom: 1px solid var(--light-gray); padding: 8px; text-align: left; vertical-align: middle; }
    .table thead th { background: var(--light-gray); }
    .table tr:hover td { background: rgba(206,213,218,0.5); }

    .chart-section { background: var(--white); border: 1px solid var(--light-gray); border-radius: var(--radius); padding: 12px; box-shadow: var(--shadow); }

    /* Témy pod sebou (1 stĺpec) */
    .assessment-form .topics-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    .topic-card { border: 1px solid var(--light-gray); border-radius: var(--radius); padding: 12px; background: var(--white); }
    .topic-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
    .badge { display: inline-flex; align-items: center; gap: 6px; padding: 2px 8px; border-radius: 999px; font-size: 0.85rem; font-weight: 700; border: 1px solid var(--light-gray); }
    .badge.io { background: rgba(161,200,97,.25); color: var(--black); }
    .badge.nio { background: rgba(255,255,96,.25); color: var(--black); }

    .topic-body { display: grid; grid-template-columns: 200px 1fr; gap: 8px; align-items: start; }
    .photo-list { display: flex; flex-wrap: wrap; gap: 8px; }
    .photo-item { border: 1px solid var(--light-gray); border-radius: 8px; padding: 4px; display: flex; align-items: center; gap: 6px; }
    .photo-item img { width: 56px; height: 56px; object-fit: cover; border-radius: 6px; border: 1px solid var(--light-gray); }

    .app-footer { padding: 14px clamp(16px,4vw,32px); border-top: 1px solid var(--light-gray); color: var(--gray); background: rgba(206,213,218,.15); text-align: center; }

    /* Panel Cloud (spodný) */
    .cloudWrap{position:relative}
    #cloudBtn{position:relative}
    #cloudPopup{position:relative;background:#fff;border:1px solid var(--light-gray);border-radius:10px;padding:10px;box-shadow:var(--shadow);min-width:320px;display:grid;gap:8px;color:#000;margin-top:10px}
    #cloudPopup[hidden]{display:none}
    .cloudRow{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .cloudRow .lbl{font-weight:600;color:#1f2937}
    .cloudRow .val{color:#4b5563}
    .cloudActions{display:flex;gap:6px;flex-wrap:wrap}
    .cloudBtn{padding:6px 10px;border:1px solid var(--light-gray);border-radius:8px;background:#fff;cursor:pointer}
    .cloudBtn:hover{background:#f3f4f6}
    .smallNote{color:#555;font-size:12px}
    .cloudError{color:#b00020;background:#fdecee;border:1px solid #f5c2c7;border-radius:8px;padding:8px 10px;display:none}
    .cloudError.show{display:block}

    .cloudOverlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:1000}
    .cloudOverlay[aria-hidden="false"]{display:flex}
    .cloudModal{width:min(680px,92vw);background:#fff;border:2px solid var(--light-gray);border-radius:10px;box-shadow:var(--shadow);overflow:hidden;color:#000}
    .cloudHeader{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:#f7f8fa;border-bottom:2px solid var(--light-gray)}
    .cloudBody{padding:12px;display:grid;gap:12px}
    .cloudGrid{display:grid;gap:10px}
    .cloudGrid .row{display:grid;grid-template-columns:180px 1fr;gap:8px;align-items:center}
    .cloudGrid label{font-weight:600;color:#1f2937}
    .cloudGrid input{width:100%;padding:8px 10px;border:1px solid #d1d5db;border-radius:8px}
    .cloudGrid input:focus{outline:none;box-shadow:0 0 0 3px rgba(161,200,97,.35);border-color:var(--lime)}

    /* Modál fotiek – menšie náhľady */
    .modal[aria-hidden="true"]{display:none}
    .modal[aria-hidden="false"]{
      position:fixed; inset:0; background:rgba(0,0,0,.35);
      display:flex; align-items:center; justify-content:center; z-index:1000;
    }
    .modal-content{
      width:min(800px,95vw); background:#fff; border:2px solid var(--light-gray);
      border-radius:10px; box-shadow:var(--shadow); overflow:hidden;
    }
    .modal-header{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px; background:rgb(206,213,218); border-bottom:1px solid var(--light-gray);
    }
    .modal-body{ padding:12px; display:flex; flex-wrap:wrap; gap:8px; }
    .modal-body img{
      width:120px; height:90px; object-fit:cover;
      border:1px solid var(--light-gray); border-radius:8px;
    }

    @media (max-width: 980px) {
      .cards { grid-template-columns: repeat(2, 1fr); }
      .grid-2 { grid-template-columns: 1fr; }
      .chart-section { margin-top: 12px; }
      .form-row { grid-template-columns: 1fr; }
      .topic-body { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <a class="skip-link" href="#main">Preskočiť na hlavný obsah</a>

  <header class="app-header" role="banner">
    <div class="brand">
      <h1>BOZP Hodnotenie pracovísk</h1>
    </div>
    <nav class="app-nav" role="navigation" aria-label="Hlavná navigácia">
      <ul>
        <li><a href="#" data-route="dashboard" class="nav-link" aria-current="page">Prehľad</a></li>
        <li><a href="#" data-route="workplaces" class="nav-link">Pracoviská</a></li>
        <li><a href="#" data-route="tasks" class="nav-link">Úlohy</a></li>
        <li><a href="#" data-route="importExport" class="nav-link">Import/Export</a></li>
      </ul>
      <!-- Horné tlačidlo Obnoviť -->
      <div class="header-actions" aria-label="Cloud akcie">
        <button id="cloudRefreshBtnTop" class="btn" type="button" title="Načítať dáta z Gistu + dohrať fotky z repo">Obnoviť</button>
      </div>
    </nav>
  </header>

  <main id="main" class="app-main" role="main">
    <!-- DASHBOARD -->
    <section id="view-dashboard" class="view" aria-labelledby="dashboard-title">
      <h2 id="dashboard-title">Prehľad a vizualizácie</h2>
      <div class="filters">
        <div class="filter-group">
          <label for="filter-segment">Segment</label>
          <select id="filter-segment" aria-label="Filter podľa segmentu">
            <option value="">Všetko</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="filter-costcenter">Nákladové stredisko</label>
          <select id="filter-costcenter" aria-label="Filter podľa nákladového strediska">
            <option value="">Všetko</option>
          </select>
        </div>
        <button id="btn-clear-filters" class="btn secondary" aria-label="Vyčistiť filtre">Vyčistiť filtre</button>
      </div>

      <div class="cards">
        <article class="card"><h3>Počet pracovísk</h3><p><span id="stat-total-workplaces" class="stat-number">0</span></p></article>
        <article class="card"><h3>Vyhodnotené</h3><p><span id="stat-assessed-workplaces" class="stat-number">0</span></p></article>
        <article class="card"><h3>% IO</h3><p><span id="stat-io-percent" class="stat-number">0%</span></p></article>
        <article class="card"><h3>% NIO</h3><p><span id="stat-nio-percent" class="stat-number">0%</span></p></article>
      </div>

      <div class="grid-2" style="margin-top:16px">
        <section class="chart-section" aria-labelledby="chart-io-nio-title">
          <h3 id="chart-io-nio-title">Pomery IO vs NIO</h3>
          <canvas id="chart-io-nio" aria-label="Koláčový graf IO vs NIO" role="img"></canvas>
        </section>
        <section class="chart-section" aria-labelledby="chart-topics-nio-title">
          <h3 id="chart-topics-nio-title">NIO podľa tém</h3>
          <canvas id="chart-topics-nio" aria-label="Stĺpcový graf NIO podľa tém" role="img"></canvas>
        </section>
      </div>
    </section>

    <!-- WORKPLACES -->
    <section id="view-workplaces" class="view" aria-labelledby="workplaces-title" hidden>
      <h2 id="workplaces-title">Správa pracovísk</h2>

      <div class="grid-2">
        <form id="form-add-workplace" class="form" aria-label="Formulár na pridanie pracoviska">
          <fieldset>
            <legend>Nové pracovisko</legend>
            <div class="form-row">
              <label for="wp-segment">Segment</label>
              <input id="wp-segment" name="segment" type="text" required aria-required="true" />
            </div>
            <div class="form-row">
              <label for="wp-costcenter">Nákladové stredisko</label>
              <input id="wp-costcenter" name="costCenter" type="text" required aria-required="true" />
            </div>
            <div class="form-row">
              <label for="wp-equipment">Equipment</label>
              <input id="wp-equipment" name="equipment" type="text" required aria-required="true" />
            </div>
            <div class="form-row">
              <label for="wp-machine">Názov stroja</label>
              <input id="wp-machine" name="machineName" type="text" required aria-required="true" />
            </div>
            <div class="form-actions">
              <button type="submit" class="btn primary">Pridať pracovisko</button>
              <button type="reset" class="btn secondary">Reset</button>
            </div>
          </fieldset>
        </form>

        <div class="panel import-panel" aria-label="Import pracovísk">
          <h3>Import pracovísk z Excel/CSV</h3>
          <p>Formát bez hlavičky: A=Segment, B=Nákladové stredisko, C=Equipment, D=Názov stroja.</p>
          <input id="file-import" type="file" accept=".xlsx,.xls,.csv" aria-label="Vybrať súbor Excel alebo CSV" />
          <div class="form-actions">
            <button id="btn-import" class="btn primary">Importovať</button>
            <button id="btn-download-template" class="btn secondary">Stiahnuť CSV šablónu</button>
          </div>
          <p id="import-status" role="status" aria-live="polite"></p>
        </div>
      </div>

      <div class="table-wrap" aria-label="Zoznam pracovísk">
        <div class="table-tools">
          <input id="search-workplaces" type="search" placeholder="Hľadať..." aria-label="Hľadať v pracoviskách" />
          <button id="btn-export-workplaces" class="btn secondary">Exportovať pracoviská (CSV)</button>
        </div>
        <table class="table" aria-describedby="workplaces-title">
          <thead>
            <tr class="thead-main">
              <th class="sortable" data-sort="segment">Segment <span class="sort-indicator" data-ind="segment">↕</span></th>
              <th class="sortable" data-sort="costCenter">Nákladové stredisko <span class="sort-indicator" data-ind="costCenter">↕</span></th>
              <th class="sortable" data-sort="equipment">Equipment <span class="sort-indicator" data-ind="equipment">↕</span></th>
              <th class="sortable" data-sort="machineName">Názov stroja <span class="sort-indicator" data-ind="machineName">↕</span></th>
              <th class="sortable" data-sort="status">Stav hodnotenia <span class="sort-indicator" data-ind="status">↕</span></th>
              <th class="sortable" data-sort="ioPercent">% IO <span class="sort-indicator" data-ind="ioPercent">↕</span></th>
              <th>Akcie</th>
            </tr>
            <tr class="thead-filters">
              <th><input id="f-segment" class="filter-input" type="text" placeholder="filter..." /></th>
              <th><input id="f-costcenter" class="filter-input" type="text" placeholder="filter..." /></th>
              <th><input id="f-equipment" class="filter-input" type="text" placeholder="filter..." /></th>
              <th><input id="f-machine" class="filter-input" type="text" placeholder="filter..." /></th>
              <th>
                <select id="f-status" class="filter-input">
                  <option value="">Všetko</option>
                  <option value="Hodnotené">Hodnotené</option>
                  <option value="Neohodnotené">Neohodnotené</option>
                </select>
              </th>
              <th><input id="f-io-min" class="filter-input" type="number" min="0" max="100" placeholder="min %" /></th>
              <th></th>
            </tr>
          </thead>
          <tbody id="workplaces-tbody"></tbody>
        </table>
      </div>
    </section>

    <!-- ASSESSMENT -->
    <section id="view-assessment" class="view" aria-labelledby="assessment-title" hidden>
      <h2 id="assessment-title">Hodnotenie tém</h2>

      <div class="selector-bar">
        <label for="assessment-workplace">Vyber pracovisko</label>
        <select id="assessment-workplace" aria-label="Vyber pracovisko pre hodnotenie">
          <option value="">-- vyber --</option>
        </select>
        <button id="btn-start-assessment" class="btn primary">Načítať hodnotenie</button>
      </div>

      <form id="form-assessment" class="form assessment-form" aria-label="Formulár hodnotenia" hidden>
        <div id="topics-container" class="topics-grid"></div>
        <div class="form-actions">
          <button type="submit" class="btn primary">Uložiť hodnotenie</button>
          <button type="button" id="btn-clear-assessment" class="btn secondary">Vyčistiť</button>
        </div>
        <p class="muted">Pri voľbe NIO je možné pridať max. 5 fotiek, nastaviť zodpovednú osobu a termín. Vznikne úloha so stavom „Otvorená“.</p>
      </form>
    </section>

    <!-- TASKS -->
    <section id="view-tasks" class="view" aria-labelledby="tasks-title" hidden>
      <h2 id="tasks-title">Úlohy z NIO</h2>

      <div class="filters">
        <div class="filter-group">
          <label for="filter-task-status">Stav</label>
          <select id="filter-task-status">
            <option value="">Všetko</option>
            <option value="Otvorená">Otvorená</option>
            <option value="V riešení">V riešení</option>
            <option value="Splnená">Splnená</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="filter-task-segment">Segment</label>
          <select id="filter-task-segment"><option value="">Všetko</option></select>
        </div>
        <div class="filter-group">
          <label for="filter-task-costcenter">Nákladové stredisko</label>
          <select id="filter-task-costcenter"><option value="">Všetko</option></select>
        </div>
        <button id="btn-export-tasks" class="btn secondary">Exportovať úlohy (CSV)</button>
      </div>

      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>Pracovisko</th>
              <th>Téma</th>
              <th>Zodpovedný</th>
              <th>Termín</th>
              <th>Stav</th>
              <th>Fotky</th>
              <th>Akcie</th>
            </tr>
          </thead>
          <tbody id="tasks-tbody"></tbody>
        </table>
      </div>
    </section>

    <!-- IMPORT/EXPORT + Cloud -->
    <section id="view-importExport" class="view" aria-labelledby="importexport-title" hidden>
      <h2 id="importexport-title">Import/Export dát</h2>

      <div class="grid-2">
        <div class="panel">
          <h3>Export databázy</h3>
          <p>Export všetkých dát (JSON) pre zálohu. Fotky sa neexportujú binárne, iba ako odkazy (remoteUrl).</p>
          <button id="btn-export-json" class="btn primary">Export JSON</button>
        </div>

        <div class="panel">
          <h3>Import databázy</h3>
          <p>Načíta JSON export a prepíše lokálnu databázu.</p>
          <input id="file-import-json" type="file" accept=".json" aria-label="Vybrať JSON súbor" />
          <button id="btn-import-json" class="btn danger">Importovať JSON</button>
          <p id="json-import-status" role="status" aria-live="polite"></p>
        </div>
      </div>

      <div class="panel" style="margin-top:16px">
        <h3>Cloud (GitHub Gist + fotky do GitHub repo)</h3>
        <div class="cloudWrap">
          <button id="cloudBtn" class="btn secondary" type="button">Cloud ▾</button>
          <div id="cloudPopup" hidden>
            <div class="cloudRow">
              <span class="lbl">Stav</span>
              <span id="cloudState" class="val">Odpojené</span>
            </div>

            <div class="cloudActions" style="margin-top:6px">
              <button id="cloudSettingsBtn" class="cloudBtn" type="button">Nastaviť ID + Token + Repo</button>
              <button id="cloudLoadBtn" class="cloudBtn" type="button">Obnoviť</button>
              <button id="cloudSaveBtn" class="cloudBtn" type="button">Uložiť</button>
              <button id="cloudUploadPhotosBtn" class="cloudBtn" type="button" title="Dohrať chýbajúce fotky do repozitára">Upload fotiek</button>
              <button id="cloudCheckBtn" class="cloudBtn" type="button" title="Skontrolovať API limity">Limit</button>
              <button id="cloudSignOutBtn" class="cloudBtn" type="button">Odhlásiť</button>
            </div>
            <div class="smallNote">JSON: GitHub Gist (súkromný). Súbor: <code>bozp_export.json</code>. Token: scope <b>gist</b>.<br>
            Fotky: GitHub repo cez Contents API. Token: scope <b>public_repo</b> (public) alebo <b>repo</b> (private).</div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="app-footer" role="contentinfo">
    <p>&copy; <span id="year"></span> BOZP Hodnotenie pracovísk. Dáta sa ukladajú lokálne a voliteľne do Gistu (JSON) a do GitHub repozitára (fotky).</p>
  </footer>

  <!-- Modál na zobrazenie fotiek -->
  <div id="modal" class="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal-content" role="document">
      <div class="modal-header">
        <h3 id="modal-title">Fotky úlohy</h3>
        <button id="modal-close" class="btn icon-btn" aria-label="Zavrieť modál">✕</button>
      </div>
      <div id="modal-body" class="modal-body"></div>
    </div>
  </div>

  <!-- Cloud Settings Modal (inline) -->
  <div id="cloudOverlay" class="cloudOverlay" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="cloudTitle">
    <div class="cloudModal">
      <div class="cloudHeader">
        <strong id="cloudTitle">Cloud nastavenia</strong>
        <button id="cloudClose" class="btn secondary" type="button">Zavrieť</button>
      </div>
      <div class="cloudBody">
        <div class="cloudGrid">
          <div class="row">
            <label for="cloudGistId">Gist ID</label>
            <input id="cloudGistId" type="text" placeholder="napr. a1b2c3d4e5f6..." />
          </div>
          <div class="row">
            <label for="cloudToken">GitHub Token</label>
            <input id="cloudToken" type="password" placeholder="ghp_… / pat_… (scopes: gist + public_repo/repo)" />
          </div>
          <div class="row">
            <label for="cloudRepoOwner">Repo Owner</label>
            <input id="cloudRepoOwner" type="text" placeholder="napr. sedivmiroslav-del" />
          </div>
          <div class="row">
            <label for="cloudRepoName">Repo Name</label>
            <input id="cloudRepoName" type="text" placeholder="napr. BOZP" />
          </div>
          <div class="row">
            <label for="cloudRepoBranch">Repo Branch</label>
            <input id="cloudRepoBranch" type="text" placeholder="main" />
          </div>
          <div class="row">
            <label for="cloudRepoFolder">Repo Folder (root)</label>
            <input id="cloudRepoFolder" type="text" placeholder="bozp-photos" />
          </div>
        </div>
        <div class="cloudActions">
          <button id="cloudSaveCreds" class="btn primary" type="button">Uložiť nastavenia</button>
          <button id="cloudCreateGist" class="btn secondary" type="button" title="Vytvorí súkromný gist s prázdnym JSONom">Vytvoriť nový Gist</button>
        </div>
        <div id="cloudError" class="cloudError"></div>
        <div id="cloudNote" class="smallNote"></div>
      </div>
    </div>
  </div>

  <!-- DB (IndexedDB) + in-memory fallback -->
  <script>
    (function(){
      const DB_NAME = 'bozpAppDB';
      const DB_VERSION = 1;
      const LS_REMOTE_UPDATED_AT = 'bozpApp/remoteUpdatedAt';

      let useMemory = false;
      const mem = {
        workplaces: [],
        assessments: new Map(), // key: workplaceId -> {workplaceId, statuses, savedAt}
        tasks: [],
        photos: [], // {id, taskId, workplaceId, topicKey, name, type, size, blob, createdAt, remoteUrl, remoteSha, uploadedAt}
        ids: { workplace: 1, task: 1, photo: 1 }
      };

      function enableMemoryFallback(reason){
        console.warn('IndexedDB unavailable, using in-memory fallback. Reason:', reason);
        useMemory = true;
      }

      function openDb(){
        return new Promise((resolve) => {
          if (!window.indexedDB) { enableMemoryFallback('no indexedDB'); resolve(null); return; }
          try {
            const req = indexedDB.open(DB_NAME, DB_VERSION);
            req.onupgradeneeded = () => {
              const db = req.result;
              if (!db.objectStoreNames.contains('workplaces')) db.createObjectStore('workplaces', { keyPath: 'id', autoIncrement: true });
              if (!db.objectStoreNames.contains('assessments')) db.createObjectStore('assessments', { keyPath: 'workplaceId' });
              if (!db.objectStoreNames.contains('tasks')) {
                const store = db.createObjectStore('tasks', { keyPath: 'id', autoIncrement: true });
                store.createIndex('status', 'status', { unique: false });
              }
              if (!db.objectStoreNames.contains('photos')) {
                const store = db.createObjectStore('photos', { keyPath: 'id', autoIncrement: true });
                store.createIndex('taskId', 'taskId', { unique: false });
              }
            };
            req.onsuccess = () => resolve(req.result);
            req.onerror   = () => { enableMemoryFallback(req.error?.name || req.error || 'open error'); resolve(null); };
          } catch (err) {
            enableMemoryFallback(err?.message || err);
            resolve(null);
          }
        });
      }

      function tx(db, stores, mode){ if(!db) return null; return db.transaction(stores, mode); }
      function getAll(store){ return new Promise((resolve, reject) => {
        if ('getAll' in store) {
          const req = store.getAll();
          req.onsuccess = () => resolve(req.result || []);
          req.onerror = () => reject(req.error);
        } else {
          const out = [];
          const req = store.openCursor();
          req.onsuccess = (e) => {
            const cursor = e.target.result;
            if (cursor) { out.push(cursor.value); cursor.continue(); }
            else resolve(out);
          };
          req.onerror = () => reject(req.error);
        }
      }); }
      function getIndexAll(index, key){ return new Promise((res,rej)=>{ const out=[]; const r=index.openCursor(key); r.onsuccess=e=>{const c=e.target.result; if(c){ out.push(c.value); c.continue(); } else res(out);}; r.onerror=()=>rej(r.error); }); }
      function getByKey(store, key){ return new Promise((res,rej)=>{ const r=store.get(key); r.onsuccess=()=>res(r.result||null); r.onerror=()=>rej(r.error); }); }
      function put(store, value){ return new Promise((res,rej)=>{ const r=store.put(value); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); }); }
      function add(store, value){ return new Promise((res,rej)=>{ const r=store.add(value); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); }); }
      function del(store, key){ return new Promise((res,rej)=>{ const r=store.delete(key); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); }); }

      window.DB = {
        async addWorkplace(w){
          const db = await openDb();
          const rec = { segment:String(w.segment||'').trim(), costCenter:String(w.costCenter||'').trim(), equipment:String(w.equipment||'').trim(), machineName:String(w.machineName||'').trim(), createdAt:Date.now() };
          if (useMemory) { const id = mem.ids.workplace++; mem.workplaces.push({ id:id, segment:rec.segment, costCenter:rec.costCenter, equipment:rec.equipment, machineName:rec.machineName, createdAt:rec.createdAt }); return id; }
          const t = tx(db, ['workplaces'], 'readwrite');
          return await add(t.objectStore('workplaces'), rec);
        },
        async listWorkplaces(){
          const db = await openDb(); if (useMemory) return mem.workplaces.slice();
          const t = tx(db, ['workplaces'], 'readonly');
          return await getAll(t.objectStore('workplaces'));
        },
        async deleteWorkplace(id){
          const db = await openDb();
          if (useMemory) {
            mem.workplaces = mem.workplaces.filter(function(w){ return w.id !== id; });
            mem.assessments.delete(id);
            const tids = mem.tasks.filter(function(t){ return t.workplaceId === id; }).map(function(t){ return t.id; });
            mem.tasks = mem.tasks.filter(function(t){ return t.workplaceId !== id; });
            mem.photos = mem.photos.filter(function(p){ return tids.indexOf(p.taskId) === -1; });
            return;
          }
          await del(tx(db, ['workplaces'], 'readwrite').objectStore('workplaces'), id);
          await del(tx(db, ['assessments'], 'readwrite').objectStore('assessments'), id);
          const t = tx(db, ['tasks','photos'], 'readwrite');
          const tasks = await getAll(t.objectStore('tasks'));
          const tids = tasks.filter(function(x){ return x.workplaceId === id; }).map(function(x){ return x.id; });
          for (const tid of tids) await del(t.objectStore('tasks'), tid);
          const idx = t.objectStore('photos').index('taskId');
          for (const tid of tids) {
            const phs = await getIndexAll(idx, tid);
            for (const p of phs) await del(t.objectStore('photos'), p.id);
          }
        },

        async getAssessment(workplaceId){
          const db = await openDb();
          if (useMemory) return mem.assessments.get(workplaceId) || null;
          return await getByKey(tx(db, ['assessments'], 'readonly').objectStore('assessments'), workplaceId);
        },
        async saveAssessment(workplaceId, statuses){
          const db = await openDb();
          const rec = { workplaceId:workplaceId, statuses:statuses||{}, savedAt:Date.now() };
          if (useMemory) { mem.assessments.set(workplaceId, rec); return; }
          await put(tx(db, ['assessments'], 'readwrite').objectStore('assessments'), rec);
        },
        async deleteAssessment(workplaceId){
          const db = await openDb();
          if (useMemory) { mem.assessments.delete(workplaceId); return; }
          await del(tx(db, ['assessments'], 'readwrite').objectStore('assessments'), workplaceId);
        },
        async cancelAssessmentForWorkplace(workplaceId){
          await this.deleteAssessment(workplaceId);
          const tasks = await this.listTasks();
          for (const t of tasks.filter(function(x){ return x.workplaceId===workplaceId; })){
            await this.deleteTask(t.id); // zmaže aj fotky danej úlohy
          }
        },

        async listTasks(filter){
          filter = filter || {};
          const db = await openDb();
          const status = filter.status || '';
          if (useMemory) {
            const arr = mem.tasks.slice();
            return status ? arr.filter(function(t){ return t.status === status; }) : arr;
          }
          const s = tx(db, ['tasks'], 'readonly').objectStore('tasks');
          return status ? await getIndexAll(s.index('status'), status) : await getAll(s);
        },
        async addTask(task){
          const db = await openDb();
          const rec = { workplaceId:task.workplaceId, topicKey:task.topicKey, responsible:task.responsible||'', dueDate:task.dueDate||null, status:task.status||'Otvorená', createdAt:Date.now() };
          if (useMemory) { const id=mem.ids.task++; mem.tasks.push({id:id, workplaceId:rec.workplaceId, topicKey:rec.topicKey, responsible:rec.responsible, dueDate:rec.dueDate, status:rec.status, createdAt:rec.createdAt}); return id; }
          return await add(tx(db,['tasks'],'readwrite').objectStore('tasks'), rec);
        },
        async updateTask(task){
          const db = await openDb();
          if (useMemory) { const i=mem.tasks.findIndex(function(x){ return x.id===task.id; }); if(i>=0) mem.tasks[i]=Object.assign({}, mem.tasks[i], task); return; }
          await put(tx(db,['tasks'],'readwrite').objectStore('tasks'), task);
        },
        async deleteTask(id){
          const db = await openDb();
          if (useMemory) { mem.tasks = mem.tasks.filter(function(t){ return t.id!==id; }); mem.photos = mem.photos.filter(function(p){ return p.taskId!==id; }); return; }
          await del(tx(db,['tasks'],'readwrite').objectStore('tasks'), id);
          const t = tx(db,['photos'],'readwrite'); const idx=t.objectStore('photos').index('taskId'); const ph=await getIndexAll(idx,id);
          for (const p of ph) await del(t.objectStore('photos'), p.id);
        },

        async addPhoto(taskId, workplaceId, topicKey, file){
          const db = await openDb();
          let type = (file && file.type) ? file.type : 'application/octet-stream';
          let size = (file && file.size) ? file.size : 0;
          const name = (file && file.name) ? file.name : 'photo';
          let blob;
          try { const buf = await file.arrayBuffer(); blob = new Blob([buf], { type:type }); }
          catch { blob = file || new Blob([], { type:type }); }
          const rec = { taskId:taskId, workplaceId:workplaceId||null, topicKey:topicKey||null, name:name, type:type, size:size, blob:blob, createdAt:Date.now(), remoteUrl:null, remoteSha:null, uploadedAt:null };
          if (useMemory) { const id=mem.ids.photo++; mem.photos.push({id:id, taskId:rec.taskId, workplaceId:rec.workplaceId, topicKey:rec.topicKey, name:rec.name, type:rec.type, size:rec.size, blob:rec.blob, createdAt:rec.createdAt, remoteUrl:null, remoteSha:null, uploadedAt:null }); return id; }
          return await add(tx(db,['photos'],'readwrite').objectStore('photos'), rec);
        },
        async listPhotosByTask(taskId){
          const db = await openDb(); if (useMemory) return mem.photos.filter(function(p){ return p.taskId===taskId; }).sort(function(a,b){ return a.createdAt-b.createdAt; });
          const idx = tx(db,['photos'],'readonly').objectStore('photos').index('taskId');
          const arr = await getIndexAll(idx, taskId);
          return arr.sort(function(a,b){ return a.createdAt-b.createdAt; });
        },
        async countPhotosForTask(taskId){
          const db = await openDb(); if (useMemory) return mem.photos.filter(function(p){ return p.taskId===taskId; }).length;
          const idx = tx(db,['photos'],'readonly').objectStore('photos').index('taskId'); const arr=await getIndexAll(idx, taskId); return arr.length;
        },
        async updatePhoto(photo){
          const db = await openDb();
          if (useMemory) { const i=mem.photos.findIndex(function(x){ return x.id===photo.id; }); if(i>=0) mem.photos[i]=Object.assign({}, mem.photos[i], photo); return; }
          await put(tx(db,['photos'],'readwrite').objectStore('photos'), photo);
        },
        async getPhoto(id){
          const db = await openDb();
          if (useMemory) return mem.photos.find(function(p){ return p.id===id; })||null;
          return await getByKey(tx(db,['photos'],'readonly').objectStore('photos'), id);
        },
        async listAllPhotos(){
          const db = await openDb();
          if (useMemory) return mem.photos.slice();
          return await getAll(tx(db,['photos'],'readonly').objectStore('photos'));
        },

        async exportJSON(){
          const workplaces = await this.listWorkplaces();
          const tasks = await this.listTasks();
          const assessments = [];
          for (const w of workplaces) { const a = await this.getAssessment(w.id); if (a) assessments.push(a); }
          const photos = await this.listAllPhotos();
          const photosLight = photos.map(function(p){
            return {
              id: p.id, taskId: p.taskId, workplaceId: p.workplaceId, topicKey: p.topicKey,
              name: p.name, type: p.type, size: p.size, createdAt: p.createdAt,
              remoteUrl: p.remoteUrl || null
            };
          });
          const meta = { version: 3, updatedAt: Date.now() };
          return { meta:meta, workplaces:workplaces, tasks:tasks, assessments:assessments, photos:photosLight };
        },

        async importJSON(data){
          const db = await openDb();
          const srcW = data.workplaces || [];
          const srcA = data.assessments || [];
          const srcT = data.tasks || [];
          const srcP = data.photos || [];

          if (useMemory) {
            mem.workplaces = srcW.map(function(w){ return Object.assign({}, w); });
            mem.assessments = new Map(); for (const a of srcA) mem.assessments.set(a.workplaceId, Object.assign({}, a));
            mem.tasks = srcT.map(function(t){ return Object.assign({}, t); });
            mem.photos = srcP.map(function(p){
              return { id:p.id, taskId:p.taskId, workplaceId:p.workplaceId||null, topicKey:p.topicKey||null, name:p.name, type:p.type||'image/*', size:p.size||0, blob:null, createdAt:p.createdAt||Date.now(), remoteUrl:p.remoteUrl||null, remoteSha:null, uploadedAt:null };
            });
            mem.ids.workplace = (Math.max(0, ...mem.workplaces.map(function(w){ return w.id; }))||0)+1;
            mem.ids.task = (Math.max(0, ...mem.tasks.map(function(t){ return t.id; }))||0)+1;
            mem.ids.photo = (Math.max(0, ...mem.photos.map(function(p){ return p.id; }))||0)+1;
            try { localStorage.setItem(LS_REMOTE_UPDATED_AT, String((data && data.meta && data.meta.updatedAt) || Date.now())); } catch {}
            return;
          }

          // wipe
          {
            const t = tx(db,['workplaces','assessments','tasks','photos'],'readwrite');
            for (const s of ['workplaces','assessments','tasks','photos']) {
              const st = t.objectStore(s); const items = await getAll(st);
              for (const it of items) await del(st, it[st.keyPath]);
            }
          }
          // import
          {
            const t = tx(db,['workplaces','assessments','tasks','photos'],'readwrite');
            const wS=t.objectStore('workplaces'), aS=t.objectStore('assessments'), tS=t.objectStore('tasks'), pS=t.objectStore('photos');
            for (const w of srcW) await put(wS, w);
            for (const a of srcA) await put(aS, a);
            for (const ta of srcT) await put(tS, ta);
            for (const p of srcP) {
              await put(pS, { id:p.id, taskId:p.taskId, workplaceId:p.workplaceId||null, topicKey:p.topicKey||null, name:p.name, type:p.type||'image/*', size:p.size||0, blob:null, createdAt:p.createdAt||Date.now(), remoteUrl:p.remoteUrl||null, remoteSha:null, uploadedAt:null });
            }
          }
          try { localStorage.setItem(LS_REMOTE_UPDATED_AT, String((data && data.meta && data.meta.updatedAt) || Date.now())); } catch {}
        }
      };
    })();
  </script>

  <!-- Charts helper -->
  <script>
    (function(){
      // Stabilné kľúče (keys) – name = dlhý popis; chartLabel = skrátený názov pre graf.
      const CHART_TOPICS = [
        { key:'ovladacie_panely', chartLabel:'Ovládacie panely', name:'Ovládacie panely dodané výrobcom nespĺňajú základné bezpečnostné štandardy' },
        { key:'suporty', chartLabel:'Suporty', name:'Suporty strojov vykonávajú zdraviu ohrozujúce pohyby (stlačením tlačidla dochádza k pohybu na doraz)' },
        { key:'koncove_spinace', chartLabel:'Koncové spínače', name:'Bezpečnostné koncové spínače sú nefunkčné alebo zámerne znefunkčnené' },
        { key:'zlaby_listy', chartLabel:'Žľaby, lišty', name:'Žľaby, lišty, výstupné pásy sú nevhodne konštruované; pri pohybe suportov dochádza k zdraviu nebezpečnému „strihu“' },
        { key:'zaseknute_diely', chartLabel:'Zaseknuté diely', name:'Pochybeniami v postupe pretypovania, poškodeniami náradia dochádza zasekávaniu dielov v strojoch (nastáva bezpečnostné riziko pri vyberaní zaseknutých dielov zo strojov – uvoľnenie pnutia suportov)' },
        { key:'zakonne_skolenia_podnikove', chartLabel:'Zákonné školenia', name:'Zákonné periodické bezpečnostné školenia nie sú dostatočne zamerané na režim pretypovania, nie sú dostatočne detailne spracované a chýbajú jednotné pravidlá školení (každý segment iný systém, iné materiály školenia...)' },
        { key:'matica_kvalifikacie', chartLabel:'Matica kvalifikácie', name:'Termíny v zákonných školeniach Matice kvalifikácie nie sú dlhodobo dodržiavané' },
        { key:'skoliace_materialy_nnos', chartLabel:'Školiace mat. (NnOS)', name:'Návody na obsluhu stroja definované výrobcom nie sú zohľadnené v školiacich materiáloch (bezpečnostných, technologických)' },
        { key:'postupy_pretypovania', chartLabel:'Postupy pretypovania', name:'Postupy pretypovania a na to nadväzujúce technologické školenia neobsahujú bezpečnostné riziká počas pretypovania' },
        { key:'cistiace_inspekcne_plany', chartLabel:'Čistenie/inspekcie', name:'Čistiace a inšpekčné plány neobsahujú vizualizáciu všetkých bezpečnostných koncových spínačov, nie je definovaný správny postup kontroly bezpečnostných koncových spínačov' },
        { key:'analyza_rizik', chartLabel:'Analýza rizík', name:'Analýzy rizík nie sú dostatočne detailne spracované pre zabezpečenie štandardov bezpečnosti práce na pracoviskách' },
        { key:'kontrolne_mechanizmy', chartLabel:'Kontrolné mechanizmy', name:'Kontrolné mechanizmy v oblasti Bezpečnosti práce nie sú nastavené dostatočne (neodhaľujú hore uvedené nedostatky v systéme bezpečnosti práce)' },
        { key:'revizia_pracoviska_ce', chartLabel:'Revízia pracoviska (CE)', name:'Neodbornými zásahmi (PDCA, IF..) do strojov dochádza k porušeniu bezpečnostných štandardov strojov daných výrobcom (CE)' },
        { key:'prebierka_stroja', chartLabel:'Prebierka stroja', name:'Dochádza k produkovaniu na strojoch, ktoré nemajú vykonanú prebierku stroja' }
      ];
      var chartPie=null, chartBar=null;

      function renderPie(ioCount, nioCount){
        var ctx=document.getElementById('chart-io-nio').getContext('2d');
        if(chartPie) chartPie.destroy();
        chartPie=new Chart(ctx,{
          type:'pie',
          data:{
            labels:['IO','NIO'],
            datasets:[{
              data:[ioCount,nioCount],
              backgroundColor:['rgb(161,200,97)','rgb(255,255,96)'],
              borderColor:['rgb(0,0,0)','rgb(0,0,0)'],
              borderWidth:1
            }]
          },
          options:{ plugins:{ legend:{ position:'bottom' } } }
        });
      }

      function renderBar(topicNioCounts){
        var ctx=document.getElementById('chart-topics-nio').getContext('2d');
        if(chartBar) chartBar.destroy();
        chartBar=new Chart(ctx,{
          type:'bar',
          data:{
            labels:CHART_TOPICS.map(function(t){ return t.chartLabel || t.name; }),
            datasets:[{
              label:'Počet NIO',
              data:CHART_TOPICS.map(function(t){ return topicNioCounts[t.key]||0; }),
              backgroundColor:'rgb(29,155,178)',
              borderColor:'rgb(0,0,0)',
              borderWidth:1
            }]
          },
          options:{
            indexAxis:'x',
            scales:{
              x:{ ticks:{ maxRotation:40, minRotation:0, autoSkip:false } },
              y:{ beginAtZero:true, ticks:{ precision:0 } }
            },
            plugins:{
              legend:{ position:'bottom' },
              tooltip:{
                callbacks:{
                  title:function(items){
                    var i = (items && items[0] && typeof items[0].dataIndex==='number') ? items[0].dataIndex : 0;
                    return (CHART_TOPICS[i] && CHART_TOPICS[i].name) ? CHART_TOPICS[i].name : (items && items[0] && items[0].label ? items[0].label : '');
                  },
                  label:function(ctx){
                    return 'Počet NIO: ' + ctx.parsed.y;
                  }
                }
              }
            }
          }
        });
      }

      window.Charts = { renderPie: renderPie, renderBar: renderBar, TOPICS: CHART_TOPICS };
    })();
  </script>

  <!-- Hlavná logika + Cloud (Gist) + GitHub Contents API (fotky) -->
  <script>
    (function(){
      const TOPICS_LIST = (window.Charts && window.Charts.TOPICS) || [];
      const ROUTES = ['dashboard', 'workplaces', 'assessment', 'tasks', 'importExport'];

      let sortKey = 'segment';
      let sortDir = 'asc';

      const LS_SYNC_CREDS_KEY = 'bozpApp/cloudCreds';
      const LS_REMOTE_UPDATED_AT = 'bozpApp/remoteUpdatedAt';
      const GIST_FILE_NAME = 'bozp_export.json';

      let syncCreds = null;

      document.addEventListener('DOMContentLoaded', init);

      function init(){
        document.getElementById('year').textContent = new Date().getFullYear();

        document.getElementById('modal-close').addEventListener('click', closeModal);
        document.getElementById('modal').addEventListener('click', (e) => { if (e.target.id === 'modal') closeModal(); });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });

        initRouting();
        refreshFilters().then(() => {
          const segEl = document.getElementById('filter-segment');
          const ccEl  = document.getElementById('filter-costcenter');
          ['change','input'].forEach(ev => {
            segEl.addEventListener(ev, updateDashboard);
            ccEl.addEventListener(ev, updateDashboard);
          });
          document.getElementById('btn-clear-filters').addEventListener('click', () => {
            segEl.value = ''; ccEl.value = '';
            updateDashboard();
          });
          updateDashboard();
        });

        bindWorkplaces();
        bindAssessment();
        bindTasks();
        bindImportExport();

        bindCloudUI();
        loadSyncCreds();
      }

      function initRouting(){
        document.querySelectorAll('.nav-link').forEach(a => {
          a.addEventListener('click', (e) => {
            e.preventDefault();
            navigate(a.getAttribute('data-route'));
          });
        });
        navigate('dashboard');
      }
      function navigate(route){
        ROUTES.forEach(r => {
          const v = document.getElementById(`view-${r}`);
          const l = document.querySelector(`.nav-link[data-route="${r}"]`);
          if (!v) return;
          const active = r === route;
          v.hidden = !active;
          if (l) { if (active) l.setAttribute('aria-current','page'); else l.removeAttribute('aria-current'); }
        });
      }

      function createEl(tag, attrs={}, children=[]){
        const el = document.createElement(tag);
        Object.entries(attrs).forEach(([k,v]) => { if (k==='class') el.className=v; else if (k==='html') el.innerHTML=v; else el.setAttribute(k,v); });
        children.forEach(ch => el.appendChild(ch));
        return el;
      }
      function fmtDate(d){ if (!d) return ''; const dt=new Date(d); return dt.toLocaleDateString(); }
      function downloadBlob(blob, name){ const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
      function toCSV(rows, headers){ const esc=v=>{ if(v==null) return ''; const s=String(v); if(s.includes('"')||s.includes(';')||s.includes('\n')) return `"${s.replace(/"/g,'""')}"`; return s; }; const head=headers.join(';'); const body=rows.map(r=>headers.map(h=>esc(r[h])).join(';')).join('\n'); return head+'\n'+body; }

      async function refreshFilters(){
        const workplaces = await DB.listWorkplaces();
        const segments = Array.from(new Set(workplaces.map(w=>w.segment))).sort();
        const costCenters = Array.from(new Set(workplaces.map(w=>w.costCenter))).sort();
        const fill = (selId, items) => {
          const sel=document.getElementById(selId);
          sel.innerHTML='<option value="">Všetko</option>';
          items.forEach(i=>{ const o=document.createElement('option'); o.value=i; o.textContent=i; sel.appendChild(o); });
        };
        fill('filter-segment', segments);
        fill('filter-costcenter', costCenters);
        fill('filter-task-segment', segments);
        fill('filter-task-costcenter', costCenters);
      }

      async function updateDashboard(){
        const seg = document.getElementById('filter-segment').value || '';
        const cc  = document.getElementById('filter-costcenter').value || '';
        const workplaces = await DB.listWorkplaces();
        const ws = workplaces.filter(w => (!seg || w.segment===seg) && (!cc || w.costCenter===cc));
        const assessments = [];
        for (const w of ws) assessments.push(await DB.getAssessment(w.id));
        const total = ws.length;
        const assessed = assessments.filter(a => a && a.statuses && Object.keys(a.statuses).length>0).length;
        let io=0, nio=0;
        const topicNioCounts={}; TOPICS_LIST.forEach(t=>topicNioCounts[t.key]=0);
        assessments.forEach(a=>{
          if (!a || !a.statuses) return;
          Object.entries(a.statuses).forEach(([key,val])=>{
            if (val==='IO') io++; else if (val==='NIO'){ nio++; topicNioCounts[key]=(topicNioCounts[key]||0)+1; }
          });
        });
        const pIO = (io+nio)>0 ? Math.round(io/(io+nio)*100) : 0;
        const pNIO = 100 - pIO;
        document.getElementById('stat-total-workplaces').textContent = total;
        document.getElementById('stat-assessed-workplaces').textContent = assessed;
        document.getElementById('stat-io-percent').textContent = pIO+'%';
        document.getElementById('stat-nio-percent').textContent = pNIO+'%';
        Charts.renderPie(io, nio);
        Charts.renderBar(topicNioCounts);
      }

      function bindWorkplaces(){
        const form = document.getElementById('form-add-workplace');
        form.addEventListener('submit', async(e)=>{
          e.preventDefault();
          const data = {
            segment:    document.getElementById('wp-segment').value,
            costCenter: document.getElementById('wp-costcenter').value,
            equipment:  document.getElementById('wp-equipment').value,
            machineName:document.getElementById('wp-machine').value
          };
          await DB.addWorkplace(data);
          form.reset();
          await loadWorkplacesTable();
          await refreshFilters();
          await fillAssessmentSelector();
          updateDashboard();
        });

        ['f-segment','f-costcenter','f-equipment','f-machine'].forEach(id=>document.getElementById(id).addEventListener('input', loadWorkplacesTable));
        document.getElementById('f-status').addEventListener('change', loadWorkplacesTable);
        document.getElementById('f-io-min').addEventListener('input', loadWorkplacesTable);
        document.getElementById('search-workplaces').addEventListener('input', loadWorkplacesTable);
        document.getElementById('btn-export-workplaces').addEventListener('click', exportWorkplacesCSV);

        document.getElementById('btn-download-template').addEventListener('click', ()=>{
          const csv='Segment;Nákladové stredisko;Equipment;Názov stroja\n';
          downloadBlob(new Blob([csv],{type:'text/csv;charset=utf-8;'}),'pracoviska_sablona.csv');
        });
        document.getElementById('btn-import').addEventListener('click', importWorkplaces);

        document.querySelectorAll('.table thead .sortable').forEach(th=>{
          th.addEventListener('click',()=>{
            const key=th.getAttribute('data-sort');
            if (key===sortKey) sortDir=(sortDir==='asc')?'desc':'asc';
            else{ sortKey=key; sortDir='asc'; }
            updateSortIndicators();
            loadWorkplacesTable();
          });
        });

        loadWorkplacesTable();
        updateSortIndicators();
      }
      function updateSortIndicators(){
        document.querySelectorAll('.sort-indicator').forEach(el=>{
          const key=el.getAttribute('data-ind');
          el.textContent = key===sortKey ? (sortDir==='asc'?'▲':'▼') : '↕';
        });
      }

      async function loadWorkplacesTable(){
        const q   = (document.getElementById('search-workplaces').value||'').toLowerCase();
        const fSeg= (document.getElementById('f-segment').value||'').toLowerCase();
        const fCc = (document.getElementById('f-costcenter').value||'').toLowerCase();
        const fEq = (document.getElementById('f-equipment').value||'').toLowerCase();
        const fMa = (document.getElementById('f-machine').value||'').toLowerCase();
        const fSt = document.getElementById('f-status').value||'';
        const fIoMin = parseInt(document.getElementById('f-io-min').value,10);

        const tbody = document.getElementById('workplaces-tbody'); tbody.innerHTML='';

        const workplaces = await DB.listWorkplaces();
        const data=[];
        for (const w of workplaces){
          const a = await DB.getAssessment(w.id);
          const percent = (function(){
            if (!a||!a.statuses) return 0;
            let io=0,nio=0; Object.values(a.statuses).forEach(function(v){ if(v==='IO') io++; else if(v==='NIO') nio++; });
            const tot=io+nio; return tot>0?Math.round(io/tot*100):0;
          })();
          data.push({ id:w.id, segment:w.segment, costCenter:w.costCenter, equipment:w.equipment, machineName:w.machineName, status:(percent>0 || (a&&Object.keys(a.statuses||{}).length>0))?'Hodnotené':'Neohodnotené', ioPercent:percent });
        }

        const filtered = data.filter(w=>{
          const hay = (w.segment+' '+w.costCenter+' '+w.equipment+' '+w.machineName).toLowerCase();
          if (q && hay.indexOf(q)===-1) return false;
          if (fSeg && String(w.segment).toLowerCase().indexOf(fSeg)===-1) return false;
          if (fCc && String(w.costCenter).toLowerCase().indexOf(fCc)===-1) return false;
          if (fEq && String(w.equipment).toLowerCase().indexOf(fEq)===-1) return false;
          if (fMa && String(w.machineName).toLowerCase().indexOf(fMa)===-1) return false;
          if (fSt && w.status!==fSt) return false;
          if (!isNaN(fIoMin) && w.ioPercent < fIoMin) return false;
          return true;
        });

        const dir = sortDir==='asc' ? 1 : -1;
        filtered.sort((a,b)=>{ let va=a[sortKey], vb=b[sortKey]; if(sortKey==='ioPercent'){va=Number(va);vb=Number(vb);} return (va>vb?1:va<vb?-1:0)*dir; });

        for (const w of filtered){
          const tr=document.createElement('tr');
          tr.innerHTML=`
            <td>${w.segment}</td>
            <td>${w.costCenter}</td>
            <td>${w.equipment}</td>
            <td>${w.machineName}</td>
            <td>${w.status}</td>
            <td>${w.ioPercent}%</td>
            <td>
              <div class="action-group">
                <button class="btn secondary" data-action="assess" data-id="${w.id}">Hodnotiť</button>
                <button class="btn danger" data-action="cancel" data-id="${w.id}">Zrušiť hodnotenie</button>
                <button class="btn danger" data-action="delete" data-id="${w.id}">Zmazať</button>
              </div>
            </td>`;
          tbody.appendChild(tr);
        }

        tbody.querySelectorAll('button[data-action="delete"]').forEach(btn=>{
          btn.addEventListener('click',async()=>{
            if(!confirm('Naozaj chcete zmazať pracovisko vrátane hodnotení a úloh?')) return;
            await DB.deleteWorkplace(Number(btn.getAttribute('data-id')));
            await loadWorkplacesTable();
            await refreshFilters();
            await fillAssessmentSelector();
            updateDashboard();
            try { await cloudSave(); } catch(e){}
          });
        });
        tbody.querySelectorAll('button[data-action="assess"]').forEach(btn=>{
          btn.addEventListener('click',async()=>{
            navigate('assessment');
            await fillAssessmentSelector();
            document.getElementById('assessment-workplace').value = btn.getAttribute('data-id');
            document.getElementById('btn-start-assessment').click();
          });
        });
        // Zrušiť hodnotenie (anuluje IO/NIO, zmaže úlohy a fotky pre dané pracovisko)
        tbody.querySelectorAll('button[data-action="cancel"]').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            if(!confirm('Zrušiť hodnotenie pre toto pracovisko? Zmažú sa aj všetky úlohy a fotky pre dané pracovisko.')) return;
            const id=Number(btn.getAttribute('data-id'));
            await DB.cancelAssessmentForWorkplace(id);
            await loadWorkplacesTable();
            await refreshFilters();
            await fillAssessmentSelector();
            updateDashboard();
            try { await cloudSave(); } catch(e){}
          });
        });
      }

      async function exportWorkplacesCSV(){
        const ws = await DB.listWorkplaces();
        const rows = ws.map(w=>({ Segment:w.segment, 'Nákladové stredisko':w.costCenter, Equipment:w.equipment, 'Názov stroja':w.machineName }));
        const csv = toCSV(rows, ['Segment','Nákladové stredisko','Equipment','Názov stroja']);
        downloadBlob(new Blob([csv],{type:'text/csv;charset=utf-8;'}),'pracoviska.csv');
      }

      async function importWorkplaces(){
        const f=document.getElementById('file-import'); const status=document.getElementById('import-status'); status.textContent='';
        const file=f.files[0]; if(!file){ status.textContent='Najprv vyberte súbor.'; return; }
        try{
          let rows=[];
          if(file.name.toLowerCase().endsWith('.csv')){
            const text=await file.text();
            rows=text.split(/\r?\n/).map(l=>l.split(';')).filter(r=>r.length>=4 && r.some(v=>v && v.trim().length>0));
          }else{
            const data=new Uint8Array(await file.arrayBuffer());
            const wb=XLSX.read(data,{type:'array'}); const ws=wb.Sheets[wb.SheetNames[0]];
            const arr=XLSX.utils.sheet_to_json(ws,{header:1,raw:true});
            rows=arr.filter(r=>r.length>=4 && r.some(v=>v && String(v).trim().length>0));
          }
          let imported=0;
          for(const r of rows){
            const segment=String(r[0]||'').trim(), costCenter=String(r[1]||'').trim(), equipment=String(r[2]||'').trim(), machineName=String(r[3]||'').trim();
            if(!segment||!costCenter||!equipment||!machineName) continue;
            await DB.addWorkplace({segment:segment,costCenter:costCenter,equipment:equipment,machineName:machineName}); imported++;
          }
          status.textContent=`Importovaných pracovísk: ${imported}`; f.value='';
          await loadWorkplacesTable(); await refreshFilters(); await fillAssessmentSelector(); updateDashboard();
        }catch(e){ console.error(e); status.textContent='Chyba pri importe súboru.'; }
      }

      function bindAssessment(){
        fillAssessmentSelector();
        document.getElementById('btn-start-assessment').addEventListener('click', startAssessment);
        document.getElementById('btn-clear-assessment').addEventListener('click', ()=>{
          document.getElementById('form-assessment').reset();
          document.getElementById('topics-container').innerHTML='';
          document.getElementById('form-assessment').hidden=true;
        });
        document.getElementById('form-assessment').addEventListener('submit', saveAssessmentForm);
      }

      async function fillAssessmentSelector(){
        const sel=document.getElementById('assessment-workplace'); const prev=sel.value;
        sel.innerHTML='<option value="">-- vyber --</option>';
        const ws=await DB.listWorkplaces();
        ws.forEach(w=>{ const o=document.createElement('option'); o.value=w.id; o.textContent=`${w.segment} | ${w.costCenter} | ${w.equipment} | ${w.machineName}`; sel.appendChild(o); });
        sel.value=prev||'';
      }

      async function startAssessment(){
        const workplaceId=Number(document.getElementById('assessment-workplace').value);
        if(!workplaceId){ alert('Prosím vyberte pracovisko.'); return; }
        const assessment=await DB.getAssessment(workplaceId);
        const statuses=assessment?.statuses || {};
        const c=document.getElementById('topics-container'); c.innerHTML='';
        TOPICS_LIST.forEach(t=>c.appendChild(createTopicCard(t, statuses[t.key]||null, workplaceId)));
        document.getElementById('form-assessment').hidden=false;
      }

      function createTopicCard(topic, currentStatus, workplaceId){
        const card=createEl('div',{class:'topic-card','data-topic':topic.key});
        const header=createEl('div',{class:'topic-header'});
        const title=createEl('h3'); title.textContent=topic.name;
        const badge=createEl('span',{class:'badge '+(currentStatus==='NIO'?'nio':currentStatus==='IO'?'io':''),'data-badge':''}); badge.textContent=currentStatus||'N/A';
        header.appendChild(title); header.appendChild(badge);
        const body=createEl('div',{class:'topic-body'});

        const radiosWrap=createEl('div',{});
        const ioId=`io-${topic.key}`, nioId=`nio-${topic.key}`;
        const io=createEl('input',{type:'radio',name:`status-${topic.key}`,id:ioId,value:'IO'});
        const ioLbl=createEl('label',{for:ioId}); ioLbl.textContent='IO';
        const nio=createEl('input',{type:'radio',name:`status-${topic.key}`,id:nioId,value:'NIO'});
        const nioLbl=createEl('label',{for:nioId}); nioLbl.textContent='NIO';
        if(currentStatus==='IO') io.checked=true; if(currentStatus==='NIO') nio.checked=true;
        radiosWrap.append(io,ioLbl,nio,nioLbl); body.appendChild(radiosWrap);

        const detail=createEl('div',{class:'nio-detail'});
        const respLbl=createEl('label',{for:`resp-${topic.key}`}); respLbl.textContent='Zodpovedný';
        const respInp=createEl('input',{id:`resp-${topic.key}`,type:'text',placeholder:'Meno priezvisko'});
        const dueLbl=createEl('label',{for:`due-${topic.key}`}); dueLbl.textContent='Termín';
        const dueInp=createEl('input',{id:`due-${topic.key}`,type:'date'});
        const fileLbl=createEl('label',{for:`file-${topic.key}`}); fileLbl.textContent='Fotky (max 5)';
        const fileInp=createEl('input',{id:`file-${topic.key}`,type:'file',accept:'image/*',multiple:'multiple'});
        const photosWrap=createEl('div',{class:'photo-list',id:`photos-${topic.key}`});
       [respLbl,respInp,dueLbl,dueInp,fileLbl,fileInp,photosWrap].forEach(el=>detail.appendChild(el));
        body.appendChild(detail);

        const updateBadge=()=>{
          const st=io.checked?'IO':(nio.checked?'NIO':'N/A');
          badge.textContent=st; badge.className='badge '+(st==='NIO'?'nio':st==='IO'?'io':'');
          detail.style.display = st==='NIO'?'grid':'none';
          detail.style.gridTemplateColumns='200px 1fr'; detail.style.gap='8px';
        };
        io.addEventListener('change',updateBadge); nio.addEventListener('change',updateBadge); updateBadge();

        loadExistingTaskData(workplaceId, topic.key, respInp, dueInp, photosWrap);

        fileInp.addEventListener('change', async ()=>{
          const files=Array.from(fileInp.files||[]); if(files.length>5){ alert('Maximálne 5 fotiek na tému.'); fileInp.value=''; return; }
          photosWrap.innerHTML=''; for(const f of files){ const url=URL.createObjectURL(f); const item=createEl('div',{class:'photo-item'}); const img=createEl('img',{src:url,alt:`Nahraná fotka: ${f.name}`}); const name=createEl('span'); name.textContent=f.name; item.append(img,name); photosWrap.appendChild(item); }
        });

        card.append(header,body);
        return card;
      }

      async function loadExistingTaskData(workplaceId, topicKey, respInput, dueInput, photosWrap){
        const tasks=await DB.listTasks(); const t=tasks.find(x=>x.workplaceId===workplaceId && x.topicKey===topicKey); if(!t) return;
        respInput.value=t.responsible||''; if(t.dueDate){ const d=new Date(t.dueDate); dueInput.value=d.toISOString().slice(0,10); }
        const photos=await DB.listPhotosByTask(t.id); photosWrap.innerHTML='';
        for(const p of photos){
          let src=''; if(p.remoteUrl) src=p.remoteUrl; else if(p.blob) src=URL.createObjectURL(p.blob); else src='';
          if(!src) continue;
          const item=createEl('div',{class:'photo-item'}); const img=createEl('img',{src:src,alt:`Fotka k téme (${topicKey})`}); const name=createEl('span'); name.textContent=p.name; item.append(img,name); photosWrap.appendChild(item);
        }
      }

      async function saveAssessmentForm(e){
        e.preventDefault();
        const workplaceId=Number(document.getElementById('assessment-workplace').value);
        if(!workplaceId) return;

        const statuses={}; const nioData={};
        for(const topic of TOPICS_LIST){
          const stIO=document.getElementById(`io-${topic.key}`).checked;
          const stNIO=document.getElementById(`nio-${topic.key}`).checked;
          const st=stIO?'IO':(stNIO?'NIO':null);
          if(st) statuses[topic.key]=st;
          if(st==='NIO'){
            const responsible=(document.getElementById(`resp-${topic.key}`).value||'').trim();
            const dueDate=document.getElementById(`due-${topic.key}`).value ? new Date(document.getElementById(`due-${topic.key}`).value).getTime() : null;
            const files=Array.from(document.getElementById(`file-${topic.key}`).files||[]);
            nioData[topic.key]={ responsible:responsible, dueDate:dueDate, files:files };
          }
        }

        await DB.saveAssessment(workplaceId, statuses);

        const existingTasks=await DB.listTasks();
        for(const[topicKey, info] of Object.entries(nioData)){
          let task=existingTasks.find(t=>t.workplaceId===workplaceId && t.topicKey===topicKey);
          let taskId;
          if(!task){ taskId=await DB.addTask({workplaceId:workplaceId, topicKey:topicKey, responsible:info.responsible, dueDate:info.dueDate, status:'Otvorená'}); }
          else { task.responsible=info.responsible; task.dueDate=info.dueDate; await DB.updateTask(task); taskId=task.id; }

          const already=await DB.countPhotosForTask(taskId);
          const canAdd=Math.max(0, 5-already);
          for(const file of info.files.slice(0, canAdd)){
            const pid=await DB.addPhoto(taskId, workplaceId, topicKey, file);
            await tryUploadPhoto(pid); // automaticky upload do repo
          }
        }

        // po uložení údajov do DB ihneď uložíme JSON do Gist (ak sú kredencialy)
        try { await cloudSave(); } catch(e) { console.warn('Cloud save po hodnotení zlyhal:', e?.message||e); }

        alert('Hodnotenie uložené.');

        // návrat na Pracoviská po uložení
        navigate('workplaces');

        updateDashboard(); loadWorkplacesTable();
      }

      function bindTasks(){
        loadTasksTable();
        ['filter-task-status','filter-task-segment','filter-task-costcenter'].forEach(id=>document.getElementById(id).addEventListener('change', loadTasksTable));
        document.getElementById('btn-export-tasks').addEventListener('click', exportTasksCSV);
      }

      // odraz stavu úlohy do hodnotenia (Splnená => IO, iné => NIO)
      async function reflectTaskStatusInAssessment(task){
        if(!task || !task.workplaceId || !task.topicKey) return;
        const current=await DB.getAssessment(task.workplaceId);
        const statuses=(current && current.statuses) ? Object.assign({}, current.statuses) : {};
        statuses[task.topicKey] = (task.status === 'Splnená') ? 'IO' : 'NIO';
        await DB.saveAssessment(task.workplaceId, statuses);
      }

      async function loadTasksTable(){
        const tbody=document.getElementById('tasks-tbody'); tbody.innerHTML='';
        const status=document.getElementById('filter-task-status').value;
        const seg=document.getElementById('filter-task-segment').value;
        const cc=document.getElementById('filter-task-costcenter').value;

        const tasks=await DB.listTasks({status:status}); const workplaces=await DB.listWorkplaces(); const wpMap=new Map(workplaces.map(w=>[w.id,w]));

        tasks
        .filter(t=>{ const w=wpMap.get(t.workplaceId); if(!w) return false; const okSeg=!seg||w.segment===seg; const okCc=!cc||w.costCenter===cc; return okSeg&&okCc; })
        .sort((a,b)=>(a.dueDate||0)-(b.dueDate||0))
        .forEach(t=>{
          const w=wpMap.get(t.workplaceId);
          const tr=document.createElement('tr');
          const overdue=t.dueDate && t.status!=='Splnená' && t.dueDate<Date.now();
          tr.innerHTML=`
            <td>${w ? `${w.segment} | ${w.costCenter} | ${w.equipment} | ${w.machineName}` : '-'}</td>
            <td>${(TOPICS_LIST.find(x=>x.key===t.topicKey)?.name) || t.topicKey}</td>
            <td>${t.responsible || '-'}</td>
            <td>${fmtDate(t.dueDate)}</td>
            <td>
              <select data-action="set-status" data-id="${t.id}">
                <option value="Otvorená" ${t.status==='Otvorená'?'selected':''}>Otvorená</option>
                <option value="V riešení" ${t.status==='V riešení'?'selected':''}>V riešení</option>
                <option value="Splnená" ${t.status==='Splnená'?'selected':''}>Splnená</option>
              </select>
              ${overdue ? '<span class="badge nio" title="Po termíne">Po termíne</span>' : ''}
            </td>
            <td>
              <button class="btn secondary" data-action="show-photos" data-id="${t.id}">Zobraziť</button>
              <input type="file" accept="image/*" multiple data-action="add-photos" data-id="${t.id}" />
            </td>
            <td><button class="btn danger" data-action="delete-task" data-id="${t.id}">Zmazať</button></td>
          `;
          tbody.appendChild(tr);
        });

        tbody.querySelectorAll('select[data-action="set-status"]').forEach(sel=>{
          sel.addEventListener('change',async()=>{
            const id=Number(sel.getAttribute('data-id'));
            const tasks=await DB.listTasks(); const t=tasks.find(x=>x.id===id); if(!t) return;
            t.status=sel.value; await DB.updateTask(t);
            await reflectTaskStatusInAssessment(t);
            await loadTasksTable();
            await loadWorkplacesTable();
            updateDashboard();
            try { await cloudSave(); } catch(e) {}
          });
        });

        tbody.querySelectorAll('button[data-action="show-photos"]').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            const id=Number(btn.getAttribute('data-id'));
            const photos=await DB.listPhotosByTask(id);
            const modalBody=document.getElementById('modal-body'); modalBody.innerHTML='';
            for(const p of photos){
              const src=p.remoteUrl ? p.remoteUrl : (p.blob ? URL.createObjectURL(p.blob) : '');
              if(!src) continue;
              const img=createEl('img',{src:src,alt:`Fotka úlohy ${p.name}`});
              modalBody.appendChild(img);
            }
            openModal();
          });
        });

        tbody.querySelectorAll('input[data-action="add-photos"]').forEach(input=>{
          input.addEventListener('change', async ()=>{
            const id=Number(input.getAttribute('data-id'));
            const already=await DB.countPhotosForTask(id);
            const files=Array.from(input.files||[]);
            for(const f of files.slice(0, Math.max(0,5-already))){
              const pid=await DB.addPhoto(id, null, null, f);
              await tryUploadPhoto(pid); // automaticky upload do repo
            }
            input.value=''; loadTasksTable();
            try { await cloudSave(); } catch(e) { console.warn('Cloud save po pridaní fotiek zlyhal:', e?.message||e); }
          });
        });

        tbody.querySelectorAll('button[data-action="delete-task"]').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            if(!confirm('Zmazať úlohu?')) return;
            const id=Number(btn.getAttribute('data-id'));
            await DB.deleteTask(id);
            loadTasksTable();
          });
        });
      }

      async function exportTasksCSV(){
        const tasks=await DB.listTasks(); const workplaces=await DB.listWorkplaces(); const wpMap=new Map(workplaces.map(w=>[w.id,w]));
        const rows=[];
        for(const t of tasks){
          const w=wpMap.get(t.workplaceId);
          const photosCount=await DB.countPhotosForTask(t.id);
          rows.push({
            Pracovisko:w?`${w.segment} | ${w.costCenter} | ${w.equipment} | ${w.machineName}`:'-',
            Téma:(TOPICS_LIST.find(x=>x.key===t.topicKey)?.name)||t.topicKey,
            Zodpovedný:t.responsible||'',
            Termín:fmtDate(t.dueDate),
            Stav:t.status,
            'Počet fotiek':photosCount
          });
        }
        const csv=toCSV(rows,['Pracovisko','Téma','Zodpovedný','Termín','Stav','Počet fotiek']);
        downloadBlob(new Blob([csv],{type:'text/csv;charset=utf-8;'}),'ulohy.csv');
      }

      function openModal(){ document.getElementById('modal').setAttribute('aria-hidden','false'); }
      function closeModal(){ document.getElementById('modal').setAttribute('aria-hidden','true'); }

      function bindImportExport(){
        document.getElementById('btn-export-json').addEventListener('click', async ()=>{
          const data=await DB.exportJSON();
          const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
          downloadBlob(blob,'bozp_export.json');
        });

        document.getElementById('btn-import-json').addEventListener('click', async ()=>{
          const file=document.getElementById('file-import-json').files[0];
          const status=document.getElementById('json-import-status'); status.textContent='';
          if(!file){ status.textContent='Vyberte JSON súbor.'; return; }
          try{
            const text=await file.text(); const data=JSON.parse(text); await DB.importJSON(data); status.textContent='Import úspešný.';
            await loadWorkplacesTable(); await refreshFilters(); await fillAssessmentSelector(); updateDashboard(); loadTasksTable();
          }catch(e){ console.error(e); status.textContent='Chybný JSON súbor.'; }
        });
      }

      /* Cloud (Gist) + GitHub repo (fotky) */
      function authHeader(tk){
        const t=(tk||'').trim();
        if (t.indexOf('github_pat_')===0) return 'Bearer ' + t;
        return 'token ' + t;
      }
      function githubHeaders(hasJson){
        const h={'Authorization':authHeader(syncCreds && syncCreds.token || ''),'Accept':'application/vnd.github+json','X-GitHub-Api-Version':'2022-11-28'};
        if(hasJson) h['Content-Type']='application/json';
        return h;
      }
      function githubHeadersWithToken(token,hasJson){
        const h={'Authorization':authHeader(token||''),'Accept':'application/vnd.github+json','X-GitHub-Api-Version':'2022-11-28'};
        if(hasJson) h['Content-Type']='application/json';
        return h;
      }
      function setCloudState(msg){ document.getElementById('cloudState').textContent=msg; }

      function loadSyncCreds(){
        try{ syncCreds=JSON.parse(localStorage.getItem(LS_SYNC_CREDS_KEY)||'null'); }catch{ syncCreds=null; }
        const idTxt=(syncCreds && syncCreds.gistId)?(syncCreds.gistId.slice(0,8)+'…'):'—';
        const repoTxt=(syncCreds && syncCreds.repoOwner && syncCreds.repoName)?(syncCreds.repoOwner+'/'+syncCreds.repoName):'—';
        setCloudState(((syncCreds && syncCreds.gistId)?('Gist '+idTxt):'Gist: —') + ' • ' + (repoTxt!=='—'?repoTxt:'Repo: —'));
      }
      function saveSyncCreds(creds){
        syncCreds={
          gistId:(creds.gistId||'').trim(),
          token:(creds.token||'').trim(),
          repoOwner:(creds.repoOwner||'').trim(),
          repoName:(creds.repoName||'').trim(),
          repoBranch:(creds.repoBranch||'main').trim(),
          repoFolder:(creds.repoFolder||'bozp-photos').trim()
        };
        localStorage.setItem(LS_SYNC_CREDS_KEY, JSON.stringify(syncCreds));
        loadSyncCreds();
      }
      function clearSyncCreds(){ localStorage.removeItem(LS_SYNC_CREDS_KEY); syncCreds=null; loadSyncCreds(); }

      function toggleCloudPopup(show){
        const pop=document.getElementById('cloudPopup'); const isShown=!pop.hasAttribute('hidden');
        const next=(typeof show==='undefined')?!isShown:!!show;
        if(next) pop.removeAttribute('hidden'); else pop.setAttribute('hidden','');
      }

      async function githubGetGist(id){
        const res=await fetch('https://api.github.com/gists/'+encodeURIComponent(id),{headers:githubHeaders(false)});
        if(!res.ok) throw new Error('HTTP '+res.status);
        return res.json();
      }

      async function cloudCheckRate(){
        if(!(syncCreds && syncCreds.token)){ alert('Cloud: chýba token.'); return; }
        try{
          const res=await fetch('https://api.github.com/rate_limit',{headers:githubHeaders(false)});
          const j=await res.json();
          const core=j && j.resources && j.resources.core ? j.resources.core : null;
          const resetTxt=core && core.reset ? new Date(core.reset*1000).toLocaleString('sk-SK') : '—';
          alert(`API limit: ${(core && core.remaining)||0}/${(core && core.limit)||0} • reset: ${resetTxt}`);
        }catch(err){ alert('Cloud: kontrola limitu zlyhala: '+(err && err.message || err)); }
      }

      async function cloudLoad(){
        if(!(syncCreds && syncCreds.gistId) || !(syncCreds && syncCreds.token)){ alert('Cloud: chýba ID alebo Token.'); return; }
        try{
          setCloudState('Načítavam…');
          const j=await githubGetGist(syncCreds.gistId);
          let file=j && j.files ? j.files[GIST_FILE_NAME] : null;
          if(!file){ alert(`V giste chýba súbor ${GIST_FILE_NAME}. Vytvorím ho pri uložení.`); setCloudState('Odpojené (chýba súbor)'); return; }
          let contentStr=file.content;
          if(!contentStr && file.raw_url){
            const rawRes=await fetch(file.raw_url,{headers:{'Accept':'application/vnd.github.v3.raw'}});
            contentStr=await rawRes.text();
          }
          const data=JSON.parse(contentStr); await DB.importJSON(data);
          try{ localStorage.setItem(LS_REMOTE_UPDATED_AT, String((data && data.meta && data.meta.updatedAt) || Date.now())); }catch{}
          setCloudState('Načítané');
          await refreshFilters(); await loadWorkplacesTable(); await fillAssessmentSelector(); updateDashboard(); loadTasksTable();
        }catch(err){ console.error(err); alert('Cloud: chyba načítania. '+(err && err.message || err)); setCloudState('Chyba načítania'); }
      }

      // GitHub Contents API helpers
      function encodePathSegments(path){ return String(path||'').split('/').map(function(seg){ return encodeURIComponent(seg); }).join('/'); }
      function sanitizeName(name){ return String(name||'').replace(/[^a-zA-Z0-9._-]+/g,'_').slice(0,120); }
      function buildPhotoPath(photo, fileName){
        const root=((syncCreds && syncCreds.repoFolder) ? syncCreds.repoFolder : 'bozp-photos').replace(/^\/+|\/+$/g,'');
        const wp=photo.workplaceId?('workplace-'+photo.workplaceId):'workplace-unknown';
        const tk=photo.taskId?('task-'+photo.taskId):'task-unknown';
        return `${root}/${wp}/${tk}/${Date.now()}-${sanitizeName(fileName||photo.name||'photo')}`;
      }
      async function listContents(owner, repo, path, branch){
        const safePath=encodePathSegments(path.replace(/^\/+|\/+$/g,''));
        const url=`https://api.github.com/repos/${encodeURIComponent(owner)}/${encodeURIComponent(repo)}/contents/${safePath}?ref=${encodeURIComponent(branch||'main')}`;
        const res=await fetch(url,{headers:githubHeaders(false)});
        if(res.status===404) return [];
        if(!res.ok) throw new Error('Get contents: HTTP '+res.status);
        const j=await res.json();
        return Array.isArray(j)?j:[j];
      }
      async function getFileSha(owner, repo, path, branch){
        const items=await listContents(owner, repo, path, branch);
        const file=items && items[0] && items[0].type==='file' ? items[0] : null;
        return file ? (file.sha || null) : null;
      }
      function bufToBase64(buf){ let binary=''; const bytes=new Uint8Array(buf); for(let i=0;i<bytes.byteLength;i++) binary+=String.fromCharCode(bytes[i]); return btoa(binary); }
      async function putFile(owner, repo, path, base64Content, message, branch, sha){
        const safePath=encodePathSegments(path);
        const url=`https://api.github.com/repos/${encodeURIComponent(owner)}/${encodeURIComponent(repo)}/contents/${safePath}`;
        const body={ message:message||`Add ${path}`, content:base64Content, branch:branch||'main' }; if(sha) body.sha=sha;
        const res=await fetch(url,{method:'PUT',headers:githubHeaders(true),body:JSON.stringify(body)});
        if(!res.ok){ const txt=await res.text(); console.warn('PUT failed:',res.status,txt); throw new Error(`Upload zlyhal: ${res.status} ${txt}`); }
        return res.json();
      }

      async function tryUploadPhoto(photoId){
        try{
          if(!(syncCreds && syncCreds.token) || !(syncCreds && syncCreds.repoOwner) || !(syncCreds && syncCreds.repoName)) return;
          const p=await DB.getPhoto(photoId); if(!p||p.remoteUrl) return; if(!p.blob) return;
          const path=buildPhotoPath(p, p.name);
          const base64=bufToBase64(await p.blob.arrayBuffer());
          const sha=await getFileSha(syncCreds.repoOwner, syncCreds.repoName, path, (syncCreds && syncCreds.repoBranch) || 'main');
          const res=await putFile(syncCreds.repoOwner, syncCreds.repoName, path, base64, `BOZP: upload ${p.name}`, (syncCreds && syncCreds.repoBranch) || 'main', sha);
          const remoteUrl=`https://raw.githubusercontent.com/${encodeURIComponent(syncCreds.repoOwner)}/${encodeURIComponent(syncCreds.repoName)}/${encodeURIComponent((syncCreds && syncCreds.repoBranch) || 'main')}/${res.content.path}`;
          p.remoteUrl=remoteUrl; p.remoteSha=res.content.sha||null; p.uploadedAt=Date.now();
          await DB.updatePhoto(p);
          try{ const tasksViewVisible=!document.getElementById('view-tasks').hidden; if(tasksViewVisible) await loadTasksTable(); }catch(e){}
        }catch(err){ console.warn('Upload fotky zlyhal:', err && err.message || err); }
      }

      async function uploadPendingPhotos(){
        if(!(syncCreds && syncCreds.token) || !(syncCreds && syncCreds.repoOwner) || !(syncCreds && syncCreds.repoName)){ alert('Nastav GitHub repo a token.'); return; }
        const all=await DB.listAllPhotos();
        const pending=all.filter(p=>!p.remoteUrl && p.blob);
        if(pending.length===0){ alert('Žiadne fotky na dohratie.'); return; }
        let ok=0,fail=0;
        for(const p of pending){ try{ await tryUploadPhoto(p.id); ok++; }catch{ fail++; } }
        alert(`Upload fotiek dokončený. OK: ${ok}, Zlyhané: ${fail}`);
      }

      // Resync fotiek z repo do lokálnej DB podľa štruktúry: repoFolder/workplace-{ID}/task-{ID}/filename
      function parseIdFromPrefixed(name, prefix){
        const re=new RegExp(`^${prefix}-(\\d+)$`);
        const m=String(name||'').match(re);
        return m ? Number(m[1]) : null;
      }
      async function resyncPhotosFromRepo(){
        if(!(syncCreds && syncCreds.token) || !(syncCreds && syncCreds.repoOwner) || !(syncCreds && syncCreds.repoName)){ console.warn('Cloud: repo kredencialy nie sú nastavené, preskakujem resync fotiek.'); return; }
        const owner=syncCreds.repoOwner, repo=syncCreds.repoName, branch=(syncCreds && syncCreds.repoBranch)||'main';
        const root=((syncCreds && syncCreds.repoFolder)||'bozp-photos').replace(/^\/+|\/+$/g,'');
        try{
          const current=await DB.listAllPhotos();
          const existingUrls=new Set(current.map(p=>p.remoteUrl).filter(Boolean));

          const workplacesDirs=await listContents(owner, repo, root, branch);
          for(const wDir of workplacesDirs.filter(x=>x.type==='dir')){
            const wid=parseIdFromPrefixed(wDir.name,'workplace'); if(!wid) continue;
            const tasksDirs=await listContents(owner, repo, `${root}/${wDir.name}`, branch);
            for(const tDir of tasksDirs.filter(x=>x.type==='dir')){
              const tid=parseIdFromPrefixed(tDir.name,'task'); if(!tid) continue;
              const files=await listContents(owner, repo, `${root}/${wDir.name}/${tDir.name}`, branch);
              for(const f of files.filter(x=>x.type==='file')){
                const remoteUrl=f.download_url;
                if(!remoteUrl || existingUrls.has(remoteUrl)) continue;
                const dummyFile=new File([new Uint8Array(0)], f.name, { type: 'image/*' });
                const pid=await DB.addPhoto(tid, wid, null, dummyFile);
                const p=await DB.getPhoto(pid);
                p.remoteUrl=remoteUrl; p.remoteSha=f.sha||null; p.uploadedAt=Date.now();
                await DB.updatePhoto(p);
                existingUrls.add(remoteUrl);
              }
            }
          }
        }catch(err){
          console.warn('Resync fotiek z repo zlyhal:', err && err.message || err);
        }
      }

      async function cloudSave(){
        if(!(syncCreds && syncCreds.gistId) || !(syncCreds && syncCreds.token)){ console.warn('Cloud: chýba ID alebo Token – preskakujem uloženie.'); return; }
        try{
          setCloudState('Ukladám…');
          const payload=await DB.exportJSON();
          const now=Date.now(); payload.meta=payload.meta||{}; payload.meta.updatedAt=now;
          const body={ files:{} }; body.files[GIST_FILE_NAME]={ content: JSON.stringify(payload,null,2) };
          const res=await fetch('https://api.github.com/gists/'+encodeURIComponent(syncCreds.gistId),{method:'PATCH',headers:githubHeaders(true),body:JSON.stringify(body)});
          if(!res.ok){ const txt=await res.text(); throw new Error('Ukladanie zlyhalo: '+txt); }
          try{ localStorage.setItem(LS_REMOTE_UPDATED_AT,String(now)); }catch{}
          setCloudState('Uložené');
        }catch(err){ console.error(err); alert('Cloud: chyba ukladania. '+(err && err.message || err)); setCloudState('Chyba ukladania'); }
      }

      async function cloudRefresh(){
        await cloudLoad();
        await resyncPhotosFromRepo();
        await loadWorkplacesTable(); await refreshFilters(); await fillAssessmentSelector(); updateDashboard(); await loadTasksTable();
      }

      function bindCloudUI(){
        const cloudBtn=document.getElementById('cloudBtn');
        const cloudOverlay=document.getElementById('cloudOverlay');
        const cloudClose=document.getElementById('cloudClose');
        const cloudGistIdInput=document.getElementById('cloudGistId');
        const cloudTokenInput=document.getElementById('cloudToken');
        const cloudRepoOwner=document.getElementById('cloudRepoOwner');
        const cloudRepoName=document.getElementById('cloudRepoName');
        const cloudRepoBranch=document.getElementById('cloudRepoBranch');
        const cloudRepoFolder=document.getElementById('cloudRepoFolder');
        const cloudSaveCreds=document.getElementById('cloudSaveCreds');
        const cloudCreateGist=document.getElementById('cloudCreateGist');
        const cloudErrorEl=document.getElementById('cloudError');
        const cloudNoteEl=document.getElementById('cloudNote');

        function showCloudError(msg){ cloudErrorEl.textContent=msg; cloudErrorEl.classList.add('show'); }
        function clearCloudError(){ cloudErrorEl.textContent=''; cloudErrorEl.classList.remove('show'); }

        cloudBtn.addEventListener('click',()=>toggleCloudPopup());
        document.addEventListener('click',(e)=>{ const pop=document.getElementById('cloudPopup'); if(!pop.hasAttribute('hidden')){ if(!e.target.closest('#cloudPopup') && !e.target.closest('#cloudBtn')) toggleCloudPopup(false); }});

        document.getElementById('cloudSettingsBtn').addEventListener('click',()=>{
          clearCloudError(); cloudNoteEl.textContent='';
          const c=syncCreds||{};
          cloudGistIdInput.value=c.gistId||''; cloudTokenInput.value=c.token||'';
          cloudRepoOwner.value=c.repoOwner||''; cloudRepoName.value=c.repoName||'';
          cloudRepoBranch.value=c.repoBranch||'main'; cloudRepoFolder.value=c.repoFolder||'bozp-photos';
          cloudOverlay.setAttribute('aria-hidden','false');
        });
        cloudClose.addEventListener('click',()=>cloudOverlay.setAttribute('aria-hidden','true'));
        cloudOverlay.addEventListener('click',(e)=>{ if(e.target===cloudOverlay) cloudOverlay.setAttribute('aria-hidden','true'); });

        cloudSaveCreds.addEventListener('click',()=>{
          const creds={ gistId:cloudGistIdInput.value.trim(), token:cloudTokenInput.value.trim(), repoOwner:cloudRepoOwner.value.trim(), repoName:cloudRepoName.value.trim(), repoBranch:cloudRepoBranch.value.trim()||'main', repoFolder:cloudRepoFolder.value.trim()||'bozp-photos' };
          if(!creds.token){ showCloudError('Vyžaduje sa token (scopes: gist + public_repo/repo).'); return; }
          saveSyncCreds(creds); alert('Cloud: nastavenia uložené.'); cloudOverlay.setAttribute('aria-hidden','true');
        });

        cloudCreateGist.addEventListener('click',async()=>{
          const tk=cloudTokenInput.value.trim()||(syncCreds && syncCreds.token)||''; if(!tk){ showCloudError('Vyžaduje sa token (scope: gist) na vytvorenie gistu.'); return; }
          try{
            const payloadStr=JSON.stringify({version:3, note:'Inicializácia BOZP App'},null,2);
            const res=await fetch('https://api.github.com/gists',{method:'POST',headers:githubHeadersWithToken(tk,true),body:JSON.stringify({description:'BOZP Workspace',public:false,files:{[GIST_FILE_NAME]:{content:payloadStr}}})});
            if(!res.ok){ const txt=await res.text(); throw new Error('Create Gist zlyhalo: '+txt); }
            const j=await res.json(); cloudGistIdInput.value=j && j.id || ''; cloudNoteEl.textContent='Vytvorený nový súkromný gist. ID: '+(j && j.id || '—');
          }catch(err){ showCloudError(err.message); }
        });

        // Spodné tlačidlá
        document.getElementById('cloudLoadBtn').addEventListener('click', cloudRefresh);
        document.getElementById('cloudSaveBtn').addEventListener('click', cloudSave);
        document.getElementById('cloudCheckBtn').addEventListener('click', cloudCheckRate);
        document.getElementById('cloudUploadPhotosBtn').addEventListener('click', uploadPendingPhotos);
        document.getElementById('cloudSignOutBtn').addEventListener('click',()=>{ if(confirm('Odhlásiť cloud nastavenia?')){ clearSyncCreds(); alert('Cloud: odhlásené.'); } });

        const refreshTop=document.getElementById('cloudRefreshBtnTop');
        if(refreshTop) refreshTop.addEventListener('click', cloudRefresh);
      }
    })();
  </script>
</body>
</html>
