<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BOZP Hodnotenie pracovísk</title>
  <meta name="description" content="Aplikácia na hodnotenie BOZP na pracoviskách s importom Excelu, úlohami, prehľadmi a podporou cloudu (Gist) + fotky v GitHub repozitári." />
  <link rel="icon" href="./assets/img/favicon.ico" type="image/x-icon">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root {
      --green: rgb(0,137,6);
      --gray: rgb(135,135,135);
      --light-gray: rgb(206,213,218);
      --blue: rgb(29,155,178);
      --lime: rgb(161,200,97);
      --white: rgb(255,255,255);
      --black: rgb(0,0,0);
      --yellow: rgb(255,255,96);

      --radius: 10px;
      --shadow: 0 8px 24px rgba(0,0,0,0.12);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--black);
      background: var(--white);
      line-height: 1.5;
    }

    .app-header {
      background: linear-gradient(90deg, var(--blue), var(--green));
      color: #fff;
      padding: 14px clamp(16px, 4vw, 32px);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }
    .brand { display: flex; align-items: center; gap: 12px; }
    .brand h1 { margin: 0; font-size: clamp(18px, 2.2vw, 26px); }

    .app-nav { display:flex; align-items:center; gap:16px; flex-wrap:wrap; }
    .app-nav ul { list-style: none; display: flex; gap: 8px; margin: 0; padding: 0; flex-wrap: wrap; }
    .app-nav a { color: #fff; text-decoration: none; padding: 8px 12px; border-radius: 8px; }
    .app-nav a:hover, .app-nav a[aria-current="page"] { background: rgba(255,255,255,0.2); }

    /* Cloud akcie v hornej lište */
    .header-actions { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .header-actions .btn { background:#fff; color:#000; border:1px solid var(--light-gray); }
    .header-actions .btn:hover { background: rgb(246,251,253); }

    .app-main { padding: 16px clamp(16px,4vw,32px); }

    .btn { appearance: none; border: 1px solid transparent; border-radius: 10px; padding: 8px 12px; font-weight: 600; cursor: pointer; transition: transform .04s, background-color .2s, border-color .2s, color .2s, box-shadow .2s; }
    .btn:active { transform: translateY(1px); }
    .btn.primary { background: var(--yellow); color: #000; border-color: rgba(0,0,0,.12); }
    .btn.primary:hover { background: rgb(245,245,120); }
    .btn.secondary { background: #fff; color: #000; border-color: var(--light-gray); }
    .btn.secondary:hover { background: rgb(246,251,253); }
    .btn.danger { background: #fff; color: #8b0000; border-color: #caa; }
    .btn.danger:hover { background: #ffecec; }
    .btn.icon-btn { background: transparent; color: var(--black); font-size: 1.2rem; border: none; }

    .cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 12px; }
    .card { background: var(--light-gray); border-radius: var(--radius); padding: 12px; box-shadow: var(--shadow); }
    .stat-number { font-size: 1.8rem; font-weight: 700; }

    .filters, .selector-bar { display: flex; flex-wrap: wrap; gap: 12px; align-items: flex-end; margin-bottom: 12px; }
    .filter-group { display: flex; flex-direction: column; min-width: 180px; }

    .form { background: var(--white); border: 1px solid var(--light-gray); border-radius: var(--radius); padding: 12px; box-shadow: var(--shadow); }
    fieldset { border: none; padding: 0; }
    legend { font-weight: 700; margin-bottom: 8px; }

    .form-row { display: grid; grid-template-columns: 200px 1fr; gap: 8px; align-items: center; margin-bottom: 8px; }
    .form-actions { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }

    input[type="text"], input[type="password"], input[type="date"], input[type="search"], input[type="number"], select {
      width: 100%; padding: 8px; border-radius: 8px; border: 1px solid var(--light-gray);
    }
    input[type="file"] { padding: 6px; border: 1px dashed var(--light-gray); border-radius: 8px; }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .panel { background: var(--white); border: 1px solid var(--light-gray); border-radius: var(--radius); padding: 12px; box-shadow: var(--shadow); }

    .table-wrap { margin-top: 16px; background: var(--white); border: 1px solid var(--light-gray); border-radius: var(--radius); overflow-x: auto; }
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { border-bottom: 1px solid var(--light-gray); padding: 8px; text-align: left; vertical-align: middle; }
    .table thead th { background: var(--light-gray); }
    .table tr:hover td { background: rgba(206,213,218,0.5); }

    .chart-section { background: var(--white); border: 1px solid var(--light-gray); border-radius: var(--radius); padding: 12px; box-shadow: var(--shadow); }

    .assessment-form .topics-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    .topic-card { border: 1px solid var(--light-gray); border-radius: var(--radius); padding: 12px; background: var(--white); }
    .topic-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
    .badge { display: inline-flex; align-items: center; gap: 6px; padding: 2px 8px; border-radius: 999px; font-size: 0.85rem; font-weight: 700; border: 1px solid var(--light-gray); }
    .badge.io { background: rgba(161,200,97,.25); color: var(--black); }
    .badge.nio { background: rgba(255,255,96,.25); color: var(--black); }

    .topic-body { display: grid; grid-template-columns: 200px 1fr; gap: 8px; align-items: start; }
    .photo-list { display: flex; flex-wrap: wrap; gap: 8px; }
    .photo-item { border: 1px solid var(--light-gray); border-radius: 8px; padding: 4px; display: flex; align-items: center; gap: 6px; }
    .photo-item img { width: 56px; height: 56px; object-fit: cover; border-radius: 6px; border: 1px solid var(--light-gray); }

    .app-footer { padding: 14px clamp(16px,4vw,32px); border-top: 1px solid var(--light-gray); color: var(--gray); background: rgba(206,213,218,.15); text-align: center; }

    /* Cloud panel */
    .cloudWrap{position:relative}
    #cloudBtn{position:relative}
    #cloudPopup{position:relative;background:#fff;border:1px solid var(--light-gray);border-radius:10px;padding:10px;box-shadow:var(--shadow);min-width:320px;display:grid;gap:8px;color:#000;margin-top:10px}
    #cloudPopup[hidden]{display:none}
    .cloudRow{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .cloudRow .lbl{font-weight:600;color:#1f2937}
    .cloudRow .val{color:#4b5563}
    .cloudActions{display:flex;gap:6px;flex-wrap:wrap}
    .cloudBtn{padding:6px 10px;border:1px solid var(--light-gray);border-radius:8px;background:#fff;cursor:pointer}
    .cloudBtn:hover{background:#f3f4f6}
    .smallNote{color:#555;font-size:12px}
    .cloudError{color:#b00020;background:#fdecee;border:1px solid #f5c2c7;border-radius:8px;padding:8px 10px;display:none}
    .cloudError.show{display:block}
    .requires-auth{ display:none !important; }
    body.authed .requires-auth{ display:inline-flex !important; }

    .cloudOverlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:1000}
    .cloudOverlay[aria-hidden="false"]{display:flex}
    .cloudModal{width:min(680px,92vw);background:#fff;border:2px solid var(--light-gray);border-radius:10px;box-shadow:var(--shadow);overflow:hidden;color:#000}
    .cloudHeader{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:#f7f8fa;border-bottom:2px solid var(--light-gray)}
    .cloudBody{padding:12px;display:grid;gap:12px}
    .cloudGrid{display:grid;gap:10px}
    .cloudGrid .row{display:grid;grid-template-columns:180px 1fr;gap:8px;align-items:center}
    .cloudGrid label{font-weight:600;color:#1f2937}
    .cloudGrid input{width:100%;padding:8px 10px;border:1px solid #d1d5db;border-radius:8px}
    .cloudGrid input:focus{outline:none;box-shadow:0 0 0 3px rgba(161,200,97,.35);border-color:var(--lime)}

    @media (max-width: 980px) {
      .cards { grid-template-columns: repeat(2, 1fr); }
      .grid-2 { grid-template-columns: 1fr; }
      .chart-section { margin-top: 12px; }
      .form-row { grid-template-columns: 1fr; }
      .topic-body { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <a class="skip-link" href="#main">Preskočiť na hlavný obsah</a>

  <header class="app-header" role="banner">
    <div class="brand">
      <h1>BOZP Hodnotenie pracovísk</h1>
    </div>

    <nav class="app-nav" role="navigation" aria-label="Hlavná navigácia">
      <ul>
        <li><a href="#" data-route="dashboard" class="nav-link" aria-current="page">Prehľad</a></li>
        <li><a href="#" data-route="workplaces" class="nav-link">Pracoviská</a></li>
        <li><a href="#" data-route="tasks" class="nav-link">Úlohy</a></li>
        <li><a href="#" data-route="importExport" class="nav-link">Import/Export</a></li>
      </ul>

      <!-- NOVÉ: Cloud akcie v hornej lište -->
      <div class="header-actions" aria-label="Cloud akcie">
        <button id="cloudLoadBtnTop"  class="btn requires-auth" type="button" title="Načítať dáta z Gistu">Načítať</button>
        <button id="cloudSaveBtnTop"  class="btn requires-auth" type="button" title="Uložiť dáta do Gistu">Uložiť</button>
        <button id="cloudUploadPhotosBtnTop" class="btn requires-auth" type="button" title="Dohrať lokálne fotky do GitHub repozitára">Upload fotiek</button>
        <button id="cloudAutoBtnTop" class="btn requires-auth" type="button" title="AutoSync JSON do Gistu">AutoSync: OFF</button>
      </div>
    </nav>
  </header>

  <main id="main" class="app-main" role="main">
    <!-- DASHBOARD -->
    <section id="view-dashboard" class="view" aria-labelledby="dashboard-title">
      <h2 id="dashboard-title">Prehľad a vizualizácie</h2>
      <div class="filters">
        <div class="filter-group">
          <label for="filter-segment">Segment</label>
          <select id="filter-segment" aria-label="Filter podľa segmentu">
            <option value="">Všetko</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="filter-costcenter">Nákladové stredisko</label>
          <select id="filter-costcenter" aria-label="Filter podľa nákladového strediska">
            <option value="">Všetko</option>
          </select>
        </div>
        <button id="btn-clear-filters" class="btn secondary" aria-label="Vyčistiť filtre">Vyčistiť filtre</button>
      </div>

      <div class="cards">
        <article class="card"><h3>Počet pracovísk</h3><p><span id="stat-total-workplaces" class="stat-number">0</span></p></article>
        <article class="card"><h3>Vyhodnotené</h3><p><span id="stat-assessed-workplaces" class="stat-number">0</span></p></article>
        <article class="card"><h3>% IO</h3><p><span id="stat-io-percent" class="stat-number">0%</span></p></article>
        <article class="card"><h3>% NIO</h3><p><span id="stat-nio-percent" class="stat-number">0%</span></p></article>
      </div>

      <div class="grid-2" style="margin-top:16px">
        <section class="chart-section" aria-labelledby="chart-io-nio-title">
          <h3 id="chart-io-nio-title">Pomery IO vs NIO</h3>
          <canvas id="chart-io-nio" aria-label="Koláčový graf IO vs NIO" role="img"></canvas>
        </section>

        <section class="chart-section" aria-labelledby="chart-topics-nio-title">
          <h3 id="chart-topics-nio-title">NIO podľa tém</h3>
          <canvas id="chart-topics-nio" aria-label="Stĺpcový graf NIO podľa tém" role="img"></canvas>
        </section>
      </div>
    </section>

    <!-- WORKPLACES -->
    <section id="view-workplaces" class="view" aria-labelledby="workplaces-title" hidden>
      <h2 id="workplaces-title">Správa pracovísk</h2>

      <div class="grid-2">
        <form id="form-add-workplace" class="form" aria-label="Formulár na pridanie pracoviska">
          <fieldset>
            <legend>Nové pracovisko</legend>
            <div class="form-row">
              <label for="wp-segment">Segment</label>
              <input id="wp-segment" name="segment" type="text" required aria-required="true" />
            </div>
            <div class="form-row">
              <label for="wp-costcenter">Nákladové stredisko</label>
              <input id="wp-costcenter" name="costCenter" type="text" required aria-required="true" />
            </div>
            <div class="form-row">
              <label for="wp-equipment">Equipment</label>
              <input id="wp-equipment" name="equipment" type="text" required aria-required="true" />
            </div>
            <div class="form-row">
              <label for="wp-machine">Názov stroja</label>
              <input id="wp-machine" name="machineName" type="text" required aria-required="true" />
            </div>
            <div class="form-actions">
              <button type="submit" class="btn primary">Pridať pracovisko</button>
              <button type="reset" class="btn secondary">Reset</button>
            </div>
          </fieldset>
        </form>

        <div class="panel import-panel" aria-label="Import pracovísk">
          <h3>Import pracovísk z Excel/CSV</h3>
          <p>Formát bez hlavičky: A=Segment, B=Nákladové stredisko, C=Equipment, D=Názov stroja.</p>
          <input id="file-import" type="file" accept=".xlsx,.xls,.csv" aria-label="Vybrať súbor Excel alebo CSV" />
          <div class="form-actions">
            <button id="btn-import" class="btn primary">Importovať</button>
            <button id="btn-download-template" class="btn secondary">Stiahnuť CSV šablónu</button>
          </div>
          <p id="import-status" role="status" aria-live="polite"></p>
        </div>
      </div>

      <div class="table-wrap" aria-label="Zoznam pracovísk">
        <div class="table-tools">
          <input id="search-workplaces" type="search" placeholder="Hľadať..." aria-label="Hľadať v pracoviskách" />
          <button id="btn-export-workplaces" class="btn secondary">Exportovať pracoviská (CSV)</button>
        </div>
        <table class="table" aria-describedby="workplaces-title">
          <thead>
            <tr class="thead-main">
              <th class="sortable" data-sort="segment">Segment <span class="sort-indicator" data-ind="segment">↕</span></th>
              <th class="sortable" data-sort="costCenter">Nákladové stredisko <span class="sort-indicator" data-ind="costCenter">↕</span></th>
              <th class="sortable" data-sort="equipment">Equipment <span class="sort-indicator" data-ind="equipment">↕</span></th>
              <th class="sortable" data-sort="machineName">Názov stroja <span class="sort-indicator" data-ind="machineName">↕</span></th>
              <th class="sortable" data-sort="status">Stav hodnotenia <span class="sort-indicator" data-ind="status">↕</span></th>
              <th class="sortable" data-sort="ioPercent">% IO <span class="sort-indicator" data-ind="ioPercent">↕</span></th>
              <th>Akcie</th>
            </tr>
            <tr class="thead-filters">
              <th><input id="f-segment" class="filter-input" type="text" placeholder="filter..." /></th>
              <th><input id="f-costcenter" class="filter-input" type="text" placeholder="filter..." /></th>
              <th><input id="f-equipment" class="filter-input" type="text" placeholder="filter..." /></th>
              <th><input id="f-machine" class="filter-input" type="text" placeholder="filter..." /></th>
              <th>
                <select id="f-status" class="filter-input">
                  <option value="">Všetko</option>
                  <option value="Hodnotené">Hodnotené</option>
                  <option value="Neohodnotené">Neohodnotené</option>
                </select>
              </th>
              <th><input id="f-io-min" class="filter-input" type="number" min="0" max="100" placeholder="min %" /></th>
              <th></th>
            </tr>
          </thead>
          <tbody id="workplaces-tbody"></tbody>
        </table>
      </div>
    </section>
    <!-- ASSESSMENT -->
    <section id="view-assessment" class="view" aria-labelledby="assessment-title" hidden>
      <h2 id="assessment-title">Hodnotenie tém</h2>

      <div class="selector-bar">
        <label for="assessment-workplace">Vyber pracovisko</label>
        <select id="assessment-workplace" aria-label="Vyber pracovisko pre hodnotenie">
          <option value="">-- vyber --</option>
        </select>
        <button id="btn-start-assessment" class="btn primary">Načítať hodnotenie</button>
      </div>

      <form id="form-assessment" class="form assessment-form" aria-label="Formulár hodnotenia" hidden>
        <div id="topics-container" class="topics-grid"></div>
        <div class="form-actions">
          <button type="submit" class="btn primary">Uložiť hodnotenie</button>
          <button type="button" id="btn-clear-assessment" class="btn secondary">Vyčistiť</button>
        </div>
        <p class="muted">Pri voľbe NIO je možné pridať max. 5 fotiek, nastaviť zodpovednú osobu a termín. Vznikne úloha so stavom „Otvorená“.</p>
      </form>
    </section>

    <!-- TASKS -->
    <section id="view-tasks" class="view" aria-labelledby="tasks-title" hidden>
      <h2 id="tasks-title">Úlohy z NIO</h2>

      <div class="filters">
        <div class="filter-group">
          <label for="filter-task-status">Stav</label>
          <select id="filter-task-status">
            <option value="">Všetko</option>
            <option value="Otvorená">Otvorená</option>
            <option value="V riešení">V riešení</option>
            <option value="Splnená">Splnená</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="filter-task-segment">Segment</label>
          <select id="filter-task-segment"><option value="">Všetko</option></select>
        </div>
        <div class="filter-group">
          <label for="filter-task-costcenter">Nákladové stredisko</label>
          <select id="filter-task-costcenter"><option value="">Všetko</option></select>
        </div>
        <button id="btn-export-tasks" class="btn secondary">Exportovať úlohy (CSV)</button>
      </div>

      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>Pracovisko</th>
              <th>Téma</th>
              <th>Zodpovedný</th>
              <th>Termín</th>
              <th>Stav</th>
              <th>Fotky</th>
              <th>Akcie</th>
            </tr>
          </thead>
          <tbody id="tasks-tbody"></tbody>
        </table>
      </div>
    </section>

    <!-- IMPORT/EXPORT + Cloud -->
    <section id="view-importExport" class="view" aria-labelledby="importexport-title" hidden>
      <h2 id="importexport-title">Import/Export dát</h2>

      <div class="grid-2">
        <div class="panel">
          <h3>Export databázy</h3>
          <p>Export všetkých dát (JSON) pre zálohu. Fotky sa neexportujú binárne, iba ako odkazy (remoteUrl).</p>
          <button id="btn-export-json" class="btn primary">Export JSON</button>
        </div>

        <div class="panel">
          <h3>Import databázy</h3>
          <p>Načíta JSON export a prepíše lokálnu databázu.</p>
          <input id="file-import-json" type="file" accept=".json" aria-label="Vybrať JSON súbor" />
          <button id="btn-import-json" class="btn danger">Importovať JSON</button>
          <p id="json-import-status" role="status" aria-live="polite"></p>
        </div>
      </div>

      <div class="panel" style="margin-top:16px">
        <h3>Cloud (GitHub Gist + fotky do GitHub repo)</h3>
        <div class="cloudWrap">
          <button id="cloudBtn" class="btn secondary" type="button">Cloud ▾</button>
          <div id="cloudPopup" hidden>
            <div class="cloudRow">
              <span class="lbl">Stav</span>
              <span id="cloudState" class="val">Odpojené</span>
            </div>
            <div class="cloudRow">
              <span class="lbl">Prístup</span>
              <span id="lockState" class="val" aria-live="polite">Zamknuté</span>
            </div>
            <div class="cloudActions" aria-label="Odomknutie">
              <input id="unlockPass" type="password" aria-label="Heslo" placeholder="Heslo" />
              <button id="unlockBtn" class="cloudBtn" type="button">Odomknúť</button>
              <button id="lockBtn" class="cloudBtn requires-auth" type="button">Zamknúť</button>
            </div>
            <div id="unlockError" class="cloudError" role="alert" aria-live="assertive"></div>

            <div class="cloudActions" style="margin-top:6px">
              <button id="cloudSettingsBtn" class="cloudBtn" type="button">Nastaviť ID + Token + Repo</button>
              <button id="cloudLoadBtn" class="cloudBtn requires-auth" type="button">Načítať</button>
              <button id="cloudSaveBtn" class="cloudBtn requires-auth" type="button">Uložiť</button>
              <button id="cloudAutoBtn" class="cloudBtn requires-auth" type="button" title="Auto nahrávanie JSONu po zmenách">AutoSync: OFF</button>
              <button id="cloudUploadPhotosBtn" class="cloudBtn requires-auth" type="button" title="Dohrať chýbajúce fotky do repozitára">Upload fotiek</button>
              <button id="cloudCheckBtn" class="cloudBtn requires-auth" type="button" title="Skontrolovať API limity">Limit</button>
              <button id="cloudSignOutBtn" class="cloudBtn requires-auth" type="button">Odhlásiť</button>
            </div>
            <div class="smallNote">JSON: GitHub Gist (súkromný). Súbor: <code>bozp_export.json</code>. Token: scope <b>gist</b>.<br>
            Fotky: GitHub repo cez Contents API. Token: scope <b>public_repo</b> (public) alebo <b>repo</b> (private).</div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="app-footer" role="contentinfo">
    <p>&copy; <span id="year"></span> BOZP Hodnotenie pracovísk. Dáta sa ukladajú lokálne a voliteľne do Gistu (JSON) a do GitHub repozitára (fotky).</p>
  </footer>

  <!-- Modál na zobrazenie fotiek -->
  <div id="modal" class="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal-content" role="document">
      <div class="modal-header">
        <h3 id="modal-title">Fotky úlohy</h3>
        <button id="modal-close" class="btn icon-btn" aria-label="Zavrieť modál">✕</button>
      </div>
      <div id="modal-body" class="modal-body"></div>
    </div>
  </div>

  <!-- Cloud Settings Modal (inline) -->
  <div id="cloudOverlay" class="cloudOverlay" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="cloudTitle">
    <div class="cloudModal">
      <div class="cloudHeader">
        <strong id="cloudTitle">Cloud nastavenia</strong>
        <button id="cloudClose" class="btn secondary" type="button">Zavrieť</button>
      </div>
      <div class="cloudBody">
        <div class="cloudGrid">
          <div class="row">
            <label for="cloudGistId">Gist ID</label>
            <input id="cloudGistId" type="text" placeholder="napr. a1b2c3d4e5f6..." />
          </div>
          <div class="row">
            <label for="cloudToken">GitHub Token</label>
            <input id="cloudToken" type="password" placeholder="ghp_… / pat_… (scopes: gist + public_repo/repo)" />
          </div>
          <div class="row">
            <label for="cloudRepoOwner">Repo Owner</label>
            <input id="cloudRepoOwner" type="text" placeholder="napr. sedivmiroslav-del" />
          </div>
          <div class="row">
            <label for="cloudRepoName">Repo Name</label>
            <input id="cloudRepoName" type="text" placeholder="napr. BOZP-photos" />
          </div>
          <div class="row">
            <label for="cloudRepoBranch">Repo Branch</label>
            <input id="cloudRepoBranch" type="text" placeholder="main" />
          </div>
          <div class="row">
            <label for="cloudRepoFolder">Repo Folder (root)</label>
            <input id="cloudRepoFolder" type="text" placeholder="bozp-photos" />
          </div>
        </div>
        <div class="cloudActions">
          <button id="cloudSaveCreds" class="btn primary" type="button">Uložiť nastavenia</button>
          <button id="cloudCreateGist" class="btn secondary requires-auth" type="button" title="Vytvorí súkromný gist s prázdnym JSONom">Vytvoriť nový Gist</button>
        </div>
        <div id="cloudError" class="cloudError"></div>
        <div id="cloudNote" class="smallNote"></div>
      </div>
    </div>
  </div>

  <!-- DB a logika ... (bez zmien oproti predchádzajúcej verzii, skrátené kvôli dĺžke) -->
  <!-- ... POZOR: celý DB a logika (vrátane funkcií cloudLoad/cloudSave/uploadPendingPhotos/tryUploadPhoto) ostávajú rovnaké ako v tvojej poslednej verzii. -->

  <!-- Charts helper (bez zmien) -->
  <!-- ... -->

  <!-- Main logic + routing + bindCloudUI s napojením horných tlačidiel -->
  <script>
    (function(){
      const TOPICS_LIST = (window.Charts && window.Charts.TOPICS) || [];
      const ROUTES = ['dashboard', 'workplaces', 'assessment', 'tasks', 'importExport'];

      let sortKey = 'segment';
      let sortDir = 'asc';

      const AUTH_PASSWORD = '31104986';
      const LS_AUTH_KEY  = 'bozpApp/authed';
      const LS_SYNC_CREDS_KEY = 'bozpApp/cloudCreds';
      const GIST_FILE_NAME = 'bozp_export.json';

      let syncCreds = null;
      let rateLimit = { remaining:null, reset:null };
      let syncTimer = null, syncBusy=false, syncBackoffMs=8000;

      document.addEventListener('DOMContentLoaded', init);

      function init(){
        document.getElementById('year').textContent = new Date().getFullYear();

        document.getElementById('modal-close').addEventListener('click', closeModal);
        document.getElementById('modal').addEventListener('click', (e) => { if (e.target.id === 'modal') closeModal(); });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });

        initRouting();
        refreshFilters().then(() => {
          const segEl = document.getElementById('filter-segment');
          const ccEl  = document.getElementById('filter-costcenter');
          ['change','input'].forEach(ev => {
            segEl.addEventListener(ev, updateDashboard);
            ccEl.addEventListener(ev, updateDashboard);
          });
          document.getElementById('btn-clear-filters').addEventListener('click', () => {
            segEl.value = ''; ccEl.value = ''; updateDashboard();
          });
          updateDashboard();
        });

        bindWorkplaces();
        bindAssessment();
        bindTasks();
        bindImportExport();

        bindCloudUI();
        loadSyncCreds();
        applyAuthFromStorage();
      }

      function initRouting(){
        const links = document.querySelectorAll('.nav-link');
        links.forEach(a => a.addEventListener('click', (e) => {
          e.preventDefault();
          navigate(a.getAttribute('data-route'));
        }));
        navigate('dashboard');
      }
      function navigate(route) {
        ROUTES.forEach(r => {
          const v = document.getElementById(`view-${r}`);
          const l = document.querySelector(`.nav-link[data-route="${r}"]`);
          if (v) {
            const active = r === route;
            v.hidden = !active;
            if (l) { if (active) l.setAttribute('aria-current','page'); else l.removeAttribute('aria-current'); }
          }
        });
      }

      function createEl(tag, attrs = {}, children = []) {
        const el = document.createElement(tag);
        Object.entries(attrs).forEach(([k, v]) => { if (k === 'class') el.className = v; else if (k === 'html') el.innerHTML = v; else el.setAttribute(k, v); });
        children.forEach(ch => el.appendChild(ch));
        return el;
      }
      function fmtDate(d) { if (!d) return ''; const dt = new Date(d); return dt.toLocaleDateString(); }
      function downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob); const a = document.createElement('a');
        a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      }
      function toCSV(rows, headers) {
        const esc = (v) => {
          if (v == null) return '';
          const s = String(v);
          if (s.includes('"') || s.includes(';') || s.includes('\n')) return `"${s.replace(/"/g, '""')}"`;
          return s;
        };
        const h = headers.join(';');
        const body = rows.map(r => headers.map(h => esc(r[h])).join(';')).join('\n');
        return h + '\n' + body;
      }

      async function refreshFilters() {
        const workplaces = await DB.listWorkplaces();
        const segments = Array.from(new Set(workplaces.map(w => w.segment))).sort();
        const costCenters = Array.from(new Set(workplaces.map(w => w.costCenter))).sort();

        const fillSelect = (sel, items) => {
          sel.innerHTML = '<option value="">Všetko</option>';
          items.forEach(i => { const opt = createEl('option', { value: i }); opt.textContent = i; sel.appendChild(opt); });
        };

        fillSelect(document.getElementById('filter-segment'), segments);
        fillSelect(document.getElementById('filter-costcenter'), costCenters);
        fillSelect(document.getElementById('filter-task-segment'), segments);
        fillSelect(document.getElementById('filter-task-costcenter'), costCenters);
      }

      async function updateDashboard() {
        const seg = document.getElementById('filter-segment').value || '';
        const cc  = document.getElementById('filter-costcenter').value || '';

        const workplaces = await DB.listWorkplaces();
        const filteredWorkplaces = workplaces.filter(w => (!seg || w.segment === seg) && (!cc || w.costCenter === cc));

        const assessments = [];
        for (const w of filteredWorkplaces) assessments.push(await DB.getAssessment(w.id));

        const totalWorkplaces = filteredWorkplaces.length;
        const assessedWorkplaces = assessments.filter(a => a && a.statuses && Object.keys(a.statuses).length > 0).length;

        let ioTotal = 0, nioTotal = 0;
        const topicNioCounts = {}; TOPICS_LIST.forEach(t => topicNioCounts[t.key] = 0);

        assessments.forEach(a => {
          if (!a || !a.statuses) return;
          Object.entries(a.statuses).forEach(([topicKey, val]) => {
            if (val === 'IO') ioTotal++;
            else if (val === 'NIO') { nioTotal++; topicNioCounts[topicKey] = (topicNioCounts[topicKey] || 0) + 1; }
          });
        });

        const percentIO  = (ioTotal + nioTotal) > 0 ? Math.round((ioTotal / (ioTotal + nioTotal)) * 100) : 0;
        const percentNIO = 100 - percentIO;

        document.getElementById('stat-total-workplaces').textContent   = totalWorkplaces;
        document.getElementById('stat-assessed-workplaces').textContent= assessedWorkplaces;
        document.getElementById('stat-io-percent').textContent         = percentIO + '%';
        document.getElementById('stat-nio-percent').textContent        = percentNIO + '%';

        Charts.renderPie(ioTotal, nioTotal);
        Charts.renderBar(topicNioCounts);
      }

      /* ... ostatné bind funkcie (workplaces/assessment/tasks/importExport) — bez zmeny ... */

      /* Cloud (Gist + GitHub repo photos) — napojenie horných tlačidiel */
      function bindCloudUI(){
        const cloudBtn  = document.getElementById('cloudBtn');
        const cloudOverlay = document.getElementById('cloudOverlay');
        const cloudClose   = document.getElementById('cloudClose');
        const cloudGistIdInput = document.getElementById('cloudGistId');
        const cloudTokenInput  = document.getElementById('cloudToken');
        const cloudRepoOwner   = document.getElementById('cloudRepoOwner');
        const cloudRepoName    = document.getElementById('cloudRepoName');
        const cloudRepoBranch  = document.getElementById('cloudRepoBranch');
        const cloudRepoFolder  = document.getElementById('cloudRepoFolder');
        const cloudSaveCreds   = document.getElementById('cloudSaveCreds');
        const cloudCreateGist  = document.getElementById('cloudCreateGist');
        const cloudErrorEl     = document.getElementById('cloudError');
        const cloudNoteEl      = document.getElementById('cloudNote');

        function showCloudError(msg){ cloudErrorEl.textContent = msg; cloudErrorEl.classList.add('show'); }
        function clearCloudError(){ cloudErrorEl.textContent=''; cloudErrorEl.classList.remove('show'); }

        cloudBtn.addEventListener('click', () => toggleCloudPopup());
        document.addEventListener('click',(e)=>{ const pop=document.getElementById('cloudPopup'); if(!pop.hasAttribute('hidden')){ if(!e.target.closest('#cloudPopup') && !e.target.closest('#cloudBtn')) toggleCloudPopup(false); }});

        document.getElementById('cloudSettingsBtn').addEventListener('click', () => {
          clearCloudError(); cloudNoteEl.textContent='';
          const c = syncCreds || {};
          cloudGistIdInput.value = c.gistId || '';
          cloudTokenInput.value  = c.token || '';
          cloudRepoOwner.value   = c.repoOwner || '';
          cloudRepoName.value    = c.repoName || '';
          cloudRepoBranch.value  = c.repoBranch || 'main';
          cloudRepoFolder.value  = c.repoFolder || 'bozp-photos';
          cloudOverlay.setAttribute('aria-hidden','false');
        });
        cloudClose.addEventListener('click', () => cloudOverlay.setAttribute('aria-hidden','true'));
        cloudOverlay.addEventListener('click', (e) => { if(e.target===cloudOverlay) cloudOverlay.setAttribute('aria-hidden','true'); });

        cloudSaveCreds.addEventListener('click', () => {
          const creds = {
            gistId: cloudGistIdInput.value.trim(),
            token:  cloudTokenInput.value.trim(),
            repoOwner: cloudRepoOwner.value.trim(),
            repoName: cloudRepoName.value.trim(),
            repoBranch: cloudRepoBranch.value.trim() || 'main',
            repoFolder: cloudRepoFolder.value.trim() || 'bozp-photos',
            auto: syncCreds?.auto||false
          };
          if (!creds.token) { showCloudError('Vyžaduje sa token (scopes: gist + public_repo/repo).'); return; }
          saveSyncCreds(creds);
          alert('Cloud: nastavenia uložené.');
          cloudOverlay.setAttribute('aria-hidden','true');
        });

        /* Existujúce dolné tlačidlá */
        document.getElementById('cloudLoadBtn').addEventListener('click', cloudLoad);
        document.getElementById('cloudSaveBtn').addEventListener('click', async()=>{ await cloudSave(); syncMaybeUpload(); });
        document.getElementById('cloudAutoBtn').addEventListener('click', () => {
          const c = syncCreds || { gistId:'', token:'', auto:false };
          c.auto = !c.auto; saveSyncCreds(c);
        });
        document.getElementById('cloudSignOutBtn').addEventListener('click', () => { if(confirm('Odhlásiť cloud nastavenia?')){ clearSyncCreds(); alert('Cloud: odhlásené.'); } });
        document.getElementById('cloudCheckBtn').addEventListener('click', cloudCheckRate);
        document.getElementById('cloudUploadPhotosBtn').addEventListener('click', uploadPendingPhotos);

        document.getElementById('unlockBtn').addEventListener('click', unlockWithPassword);
        document.getElementById('unlockPass').addEventListener('keydown', (e) => { if(e.key==='Enter'){ e.preventDefault(); unlockWithPassword(); }});
        document.getElementById('lockBtn').addEventListener('click', lockUI);

        /* NOVÉ: horné tlačidlá v headeri */
        const loadTop  = document.getElementById('cloudLoadBtnTop');
        const saveTop  = document.getElementById('cloudSaveBtnTop');
        const uploadTop= document.getElementById('cloudUploadPhotosBtnTop');
        const autoTop  = document.getElementById('cloudAutoBtnTop');

        if (loadTop)  loadTop.addEventListener('click', cloudLoad);
        if (saveTop)  saveTop.addEventListener('click', async()=>{ await cloudSave(); syncMaybeUpload(); });
        if (uploadTop) uploadTop.addEventListener('click', uploadPendingPhotos);
        if (autoTop)  autoTop.addEventListener('click', () => {
          const c = syncCreds || { gistId:'', token:'', auto:false };
          c.auto = !c.auto; saveSyncCreds(c);
        });
      }

      function updateLockStateUI(){
        const lockState = document.getElementById('lockState');
        lockState.textContent = document.body.classList.contains('authed') ? 'Odomknuté' : 'Zamknuté';
        const errEl = document.getElementById('unlockError'); errEl.classList.remove('show'); errEl.textContent='';
      }
      function applyAuthFromStorage(){
        const unlocked = localStorage.getItem(LS_AUTH_KEY)==='1';
        document.body.classList.toggle('authed', !!unlocked);
        /* aktualizuj text horného AutoSync tlačidla */
        const autoTop = document.getElementById('cloudAutoBtnTop');
        if (autoTop) autoTop.textContent = 'AutoSync: ' + ((JSON.parse(localStorage.getItem(LS_SYNC_CREDS_KEY)||'{}')?.auto) ? 'ON' : 'OFF');
        updateLockStateUI();
      }
    })();
  </script>
</body>
</html>
